<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>积木编排</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 space-y-3">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-semibold">🧱 积木编排</h1>
      <div class="space-x-2">
        <button id="saveBtn" class="px-3 py-1.5 rounded-md bg-amber-500 text-white">保存并发布</button>
        <button onclick="window.close()" class="px-3 py-1.5 rounded-md bg-gray-200">关闭</button>
      </div>
    </div>
    <div id="hint" class="text-sm text-gray-500"></div>
    <div id="blocklyArea" class="h-[72vh] bg-white rounded-xl shadow"></div>
  </div>

<script>
// ---------------- URL 参数 ----------------
const params = new URLSearchParams(location.search);
const botId = params.get('bot_id');
const flowId = params.get('flow_id');
document.getElementById('hint').innerText = botId ? `目标 Bot: #${botId}${flowId? '，编辑 Flow #'+flowId : '，新建 Flow'}` : '缺少 bot_id 参数';

// ---------------- 自定义块（先定义，再注入） ----------------
Blockly.defineBlocksWithJsonArray([
  // 入口
  {"type":"on_command","message0":"当收到命令 /%1","args0":[{"type":"field_input","name":"CMD","text":"guess"}],
   "nextStatement":null, "colour":210, "tooltip":"入口块（一个命令一个入口）"},

  // 发送文本（带 ParseMode & 预览）
  {"type":"send_text","message0":"发送文本 %1","args0":[{"type":"field_input","name":"TEXT","text":"你好，{{user.first_name}}"}],
   "message1":"ParseMode %1  禁用链接预览 %2",
   "args1":[{"type":"field_dropdown","name":"PARSE","options":[["None",""],["HTML","HTML"],["MarkdownV2","MarkdownV2"]]},
            {"type":"field_checkbox","name":"NOPREVIEW","checked":false}],
   "previousStatement":null, "nextStatement":null, "colour":160},

  // 媒体
  {"type":"send_photo","message0":"发送图片 URL %1 说明 %2",
   "args0":[{"type":"field_input","name":"URL","text":"https://..."},{"type":"field_input","name":"CAP","text":""}],
   "previousStatement":null, "nextStatement":null, "colour":160},
  {"type":"send_document","message0":"发送文档 URL %1 说明 %2",
   "args0":[{"type":"field_input","name":"URL","text":"https://..."},{"type":"field_input","name":"CAP","text":""}],
   "previousStatement":null, "nextStatement":null, "colour":160},
  {"type":"send_animation","message0":"发送动画/GIF URL %1 说明 %2",
   "args0":[{"type":"field_input","name":"URL","text":"https://..."},{"type":"field_input","name":"CAP","text":""}],
   "previousStatement":null, "nextStatement":null, "colour":160},
  {"type":"send_voice","message0":"发送语音 URL %1 说明 %2",
   "args0":[{"type":"field_input","name":"URL","text":"https://..."},{"type":"field_input","name":"CAP","text":""}],
   "message1":"ParseMode %1",
   "args1":[{"type":"field_dropdown","name":"PARSE","options":[["None",""],["HTML","HTML"],["MarkdownV2","MarkdownV2"]]}],
   "previousStatement":null, "nextStatement":null, "colour":160},
  {"type":"send_sticker","message0":"发送贴纸 file_id %1",
   "args0":[{"type":"field_input","name":"FILE","text":"CAACAgUAAxkBAAIDlmT63..."}],
   "previousStatement":null, "nextStatement":null, "colour":160},
  {"type":"send_text_keyboard","message0":"发送文本+按钮 %1",
   "args0":[{"type":"field_input","name":"TEXT","text":"请选择操作"}],
   "message1":"按钮 JSON %1",
   "args1":[{"type":"field_input","name":"KB","text":"[[{\"text\":\"按钮\",\"callback_data\":\"ping\"}]]"}],
   "message2":"ParseMode %1  禁用预览 %2",
   "args2":[{"type":"field_dropdown","name":"PARSE","options":[["None",""],["HTML","HTML"],["MarkdownV2","MarkdownV2"]]},
            {"type":"field_checkbox","name":"NOPREVIEW","checked":false}],
   "previousStatement":null, "nextStatement":null, "colour":160},

  // 变量：写入（随机/文本）、读取到临时变量、自增
  {"type":"set_var_rand","message0":"设置 作用域 %1 变量 %2 = 随机 %3 到 %4",
   "args0":[{"type":"field_dropdown","name":"SCOPE","options":[["chat","chat"],["user","user"],["bot","bot"]]},
            {"type":"field_input","name":"KEY","text":"secret"},
            {"type":"field_number","name":"MIN","value":1},
            {"type":"field_number","name":"MAX","value":100}],
   "previousStatement":null, "nextStatement":null, "colour":60},
  {"type":"set_var_val","message0":"设置 作用域 %1 变量 %2 = 文本 %3",
   "args0":[{"type":"field_dropdown","name":"SCOPE","options":[["chat","chat"],["user","user"],["bot","bot"]]},
            {"type":"field_input","name":"KEY","text":"name"},
            {"type":"field_input","name":"VAL","text":"{{user.username}}"}],
   "previousStatement":null, "nextStatement":null, "colour":60},
  {"type":"inc_var","message0":"自增 作用域 %1 变量 %2 步长 %3",
   "args0":[{"type":"field_dropdown","name":"SCOPE","options":[["chat","chat"],["user","user"],["bot","bot"]]},
            {"type":"field_input","name":"KEY","text":"count"},
            {"type":"field_number","name":"STEP","value":1}],
   "previousStatement":null, "nextStatement":null, "colour":60},
  {"type":"get_var","message0":"读取 作用域 %1 变量 %2 → 临时名 %3",
   "args0":[{"type":"field_dropdown","name":"SCOPE","options":[["chat","chat"],["user","user"],["bot","bot"]]},
            {"type":"field_input","name":"KEY","text":"secret"},
            {"type":"field_input","name":"ALIAS","text":"x"}],
   "previousStatement":null, "nextStatement":null, "colour":200},
  {"type":"set_local_from_input","message0":"令 临时变量 %1 = 当前消息文本",
   "args0":[{"type":"field_input","name":"ALIAS","text":"guess"}],
   "previousStatement":null, "nextStatement":null, "colour":200},

  // 条件（用临时变量）
  {"type":"if_var","message0":"如果 临时变量 %1 %2 %3",
   "args0":[{"type":"field_input","name":"LHS","text":"x"},
            {"type":"field_dropdown","name":"OP","options":[["=","eq"],["≠","ne"],["包含","contains"],[">","gt"],["<","lt"]]},
            {"type":"field_input","name":"RHS","text":"42"}],
   "message1":"那么 %1","args1":[{"type":"input_statement","name":"THEN"}],
   "message2":"否则 %1","args2":[{"type":"input_statement","name":"ELSE"}],
   "previousStatement":null, "nextStatement":null, "colour":20},

  // 等待下一条消息
  {"type":"wait_next","message0":"等待下一条消息（%1） 并提示 %2",
   "args0":[{"type":"field_dropdown","name":"EXPECT","options":[["任意","any"],["数字","number"]]},
            {"type":"field_input","name":"PROMPT","text":"请输入…"}],
   "previousStatement":null, "nextStatement":null, "colour":290},

  // 延迟执行
  {"type":"delay_seconds","message0":"等待 %1 秒",
   "args0":[{"type":"field_number","name":"SEC","value":3,"min":0,"max":300,"precision":0.5}],
   "previousStatement":null, "nextStatement":null, "colour":290},

  // HTTP（headers/body + 保存 JSON 路径）
  {"type":"http_block","message0":"HTTP %1 %2",
   "args0":[{"type":"field_dropdown","name":"METHOD","options":[["GET","GET"],["POST","POST"]]},
            {"type":"field_input","name":"URL","text":"https://api.github.com/zen"}],
   "message1":"Headers(JSON) %1","args1":[{"type":"field_input","name":"HEAD","text":"{}"}],
   "message2":"Body(JSON) %1","args2":[{"type":"field_input","name":"BODY","text":""}],
   "message3":"保存到 %1.%2（JSON路径可选 %3 ）",
   "args3":[{"type":"field_dropdown","name":"SCOPE","options":[["chat","chat"],["user","user"],["bot","bot"]]},
            {"type":"field_input","name":"KEY","text":"resp"},
            {"type":"field_input","name":"JPATH","text":""}],
   "previousStatement":null, "nextStatement":null, "colour":300}
]);

// ---------------- 注入 ----------------
const workspace = Blockly.inject('blocklyArea', {
  toolbox: {
    "kind": "flyoutToolbox",
    "contents": [
      { "kind":"label","text":"触发" },
      { "kind":"block","type":"on_command" },

      { "kind":"label","text":"动作" },
      { "kind":"block","type":"send_text" },
      { "kind":"block","type":"send_photo" },
      { "kind":"block","type":"send_document" },
      { "kind":"block","type":"send_animation" },
      { "kind":"block","type":"send_voice" },
      { "kind":"block","type":"send_sticker" },
      { "kind":"block","type":"send_text_keyboard" },

      { "kind":"label","text":"变量" },
      { "kind":"block","type":"set_var_val" },
      { "kind":"block","type":"set_var_rand" },
      { "kind":"block","type":"inc_var" },
      { "kind":"block","type":"get_var" },
      { "kind":"block","type":"set_local_from_input" },

      { "kind":"label","text":"逻辑" },
      { "kind":"block","type":"if_var" },
      { "kind":"block","type":"wait_next" },
      { "kind":"block","type":"delay_seconds" },

      { "kind":"label","text":"网络" },
      { "kind":"block","type":"http_block" }
    ]
  },
  scrollbars: true,
  trashcan: true,
});

// ---------------- 工具：稳健解析 & 旧数据重建 ----------------
function safeParseBlocksJson(raw) {
  try {
    let x = raw;
    if (typeof x === 'string') {
      x = JSON.parse(x);
      if (typeof x === 'string') x = JSON.parse(x);
    }
    return (x && typeof x === 'object') ? x : null;
  } catch(e) {
    console.warn('safeParseBlocksJson failed:', e);
    return null;
  }
}

function rebuildFromCompiled(compiled){
  if(!compiled || !Array.isArray(compiled.entries)) return;
  workspace.clear();

  let offsetX = 20;
  const chainTo = (prev, block) => {
    block.initSvg(); block.render();
    if(prev && prev.nextConnection && block.previousConnection){
      prev.nextConnection.connect(block.previousConnection);
    }
    return block;
  };

  compiled.entries.forEach((entry)=>{
    // 入口
    const on = workspace.newBlock('on_command');
    on.setFieldValue((entry.command||'/cmd').replace(/^\//,''), 'CMD');
    on.initSvg(); on.render(); on.moveBy(offsetX, 20);

    let prev = on;

    const applyBasicSend = (node) => {
      let b = null;
      if(node.type==='send_text'){
        b = workspace.newBlock('send_text');
        b.setFieldValue(node.text || '', 'TEXT');
        b.setFieldValue(node.parse_mode || '', 'PARSE');
        b.setFieldValue(node.disable_preview ? 'TRUE' : 'FALSE', 'NOPREVIEW');
      } else if(node.type==='send_photo'){
        b = workspace.newBlock('send_photo');
        b.setFieldValue(node.url || '', 'URL');
        b.setFieldValue(node.caption || '', 'CAP');
      } else if(node.type==='send_document'){
        b = workspace.newBlock('send_document');
        b.setFieldValue(node.url || '', 'URL');
        b.setFieldValue(node.caption || '', 'CAP');
      } else if(node.type==='send_animation'){
        b = workspace.newBlock('send_animation');
        b.setFieldValue(node.url || '', 'URL');
        b.setFieldValue(node.caption || '', 'CAP');
      } else if(node.type==='send_voice'){
        b = workspace.newBlock('send_voice');
        b.setFieldValue(node.url || '', 'URL');
        b.setFieldValue(node.caption || '', 'CAP');
        b.setFieldValue(node.parse_mode || '', 'PARSE');
      } else if(node.type==='send_sticker'){
        b = workspace.newBlock('send_sticker');
        b.setFieldValue(node.file_id || node.sticker || '', 'FILE');
      } else if(node.type==='send_text_keyboard'){
        b = workspace.newBlock('send_text_keyboard');
        b.setFieldValue(node.text || '', 'TEXT');
        const kbRaw = node.keyboard || node.keyboard_json || node.buttons;
        b.setFieldValue(typeof kbRaw === 'string' ? kbRaw : (kbRaw ? JSON.stringify(kbRaw) : ''), 'KB');
        b.setFieldValue(node.parse_mode || '', 'PARSE');
        b.setFieldValue(node.disable_preview ? 'TRUE' : 'FALSE', 'NOPREVIEW');
      } else if(node.type==='delay'){
        b = workspace.newBlock('delay_seconds');
        b.setFieldValue(String(node.seconds || 0), 'SEC');
      }
      if (b) {
        prev = chainTo(prev, b);
      }
    };

    const nodes = entry.nodes || [];
    for(let i=0; i<nodes.length; i++){
      const n = nodes[i];
      switch(n.type){
        case 'send_text':
        case 'send_photo':
        case 'send_document':
        case 'send_animation':
        case 'send_voice':
        case 'send_sticker':
        case 'send_text_keyboard':
        case 'delay':
          applyBasicSend(n);
          break;

        case 'set_var': {
          const mode = n.mode || (n.random ? 'random' : 'text');
          if(mode==='random'){
            const b = workspace.newBlock('set_var_rand');
            b.setFieldValue(n.scope || 'chat', 'SCOPE');
            b.setFieldValue(n.key || 'k', 'KEY');
            const rr = n.random || {};
            b.setFieldValue(String(rr.min ?? 1), 'MIN');
            b.setFieldValue(String(rr.max ?? 100), 'MAX');
            prev = chainTo(prev, b);
          }else{
            const b = workspace.newBlock('set_var_val');
            b.setFieldValue(n.scope || 'chat', 'SCOPE');
            b.setFieldValue(n.key || 'k', 'KEY');
            b.setFieldValue(n.value || '', 'VAL');
            prev = chainTo(prev, b);
          }
          break;
        }

        case 'inc_var': {
          const b = workspace.newBlock('inc_var');
          b.setFieldValue(n.scope || 'chat', 'SCOPE');
          b.setFieldValue(n.key || 'count', 'KEY');
          b.setFieldValue(String(n.step ?? 1), 'STEP');
          prev = chainTo(prev, b);
          break;
        }

        case 'get_var': {
          const b = workspace.newBlock('get_var');
          b.setFieldValue(n.scope || 'chat', 'SCOPE');
          b.setFieldValue(n.key || 'k', 'KEY');
          b.setFieldValue(n.alias || 'x', 'ALIAS');
          prev = chainTo(prev, b);
          break;
        }

        case 'set_local_from_input': {
          const b = workspace.newBlock('set_local_from_input');
          b.setFieldValue(n.alias || 'x', 'ALIAS');
          prev = chainTo(prev, b);
          break;
        }

        // 旧版 if（无变量），尽力映射成 if_var（用临时变量 x）
        case 'if':
        case 'if_var': {
          const b = workspace.newBlock('if_var');
          if (n.type === 'if_var') {
             b.setFieldValue((n.left && n.left.var) || 'x', 'LHS');
             b.setFieldValue(n.op || 'eq', 'OP');
             b.setFieldValue((n.right && n.right.text) || '', 'RHS');
          } else { // 'if'
            b.setFieldValue('x', 'LHS');
            b.setFieldValue(n.op || 'eq', 'OP');
            b.setFieldValue((n.right && (n.right.text||'')) || '', 'RHS');
          }

          const buildBranch = (branchNodes, inputName) => {
              let branchPrev = null;
              (branchNodes||[]).forEach(nn=>{
                let nb=null;
                if(nn.type==='send_text'){ nb=workspace.newBlock('send_text'); nb.setFieldValue(nn.text||'','TEXT'); }
                else if(nn.type==='send_photo'){ nb=workspace.newBlock('send_photo'); nb.setFieldValue(nn.url||'','URL'); nb.setFieldValue(nn.caption||'','CAP'); }
                else if(nn.type==='send_document'){ nb=workspace.newBlock('send_document'); nb.setFieldValue(nn.url||'','URL'); nb.setFieldValue(nn.caption||'','CAP'); }
                else if(nn.type==='send_animation'){ nb=workspace.newBlock('send_animation'); nb.setFieldValue(nn.url||'','URL'); nb.setFieldValue(nn.caption||'','CAP'); }
                else if(nn.type==='send_voice'){ nb=workspace.newBlock('send_voice'); nb.setFieldValue(nn.url||'','URL'); nb.setFieldValue(nn.caption||'','CAP'); nb.setFieldValue(nn.parse_mode||'','PARSE'); }
                else if(nn.type==='send_sticker'){ nb=workspace.newBlock('send_sticker'); nb.setFieldValue(nn.file_id||nn.sticker||'','FILE'); }
                else if(nn.type==='send_text_keyboard'){ nb=workspace.newBlock('send_text_keyboard'); nb.setFieldValue(nn.text||'','TEXT'); nb.setFieldValue(typeof nn.keyboard==='string'?nn.keyboard:(nn.keyboard?JSON.stringify(nn.keyboard): (nn.keyboard_json||'')),'KB'); nb.setFieldValue(nn.parse_mode||'','PARSE'); nb.setFieldValue(nn.disable_preview?'TRUE':'FALSE','NOPREVIEW'); }
                else if(nn.type==='delay'){ nb=workspace.newBlock('delay_seconds'); nb.setFieldValue(String(nn.seconds||0),'SEC'); }
                if(nb){
                  nb.initSvg(); nb.render();
                  if(!branchPrev){ b.getInput(inputName).connection.connect(nb.previousConnection); }
                  else{ branchPrev.nextConnection.connect(nb.previousConnection); }
                  branchPrev = nb;
                }
              });
          };

          buildBranch(n.then, 'THEN');
          buildBranch(n.else, 'ELSE');

          prev = chainTo(prev, b);
          break;
        }

        case 'http': {
          const b = workspace.newBlock('http_block');
          b.setFieldValue(n.method || 'GET', 'METHOD');
          b.setFieldValue(n.url || '', 'URL');
          b.setFieldValue(
            (typeof n.headers==='string') ? n.headers : (n.headers? JSON.stringify(n.headers):''),
            'HEAD'
          );
          b.setFieldValue(
            (typeof n.body==='string') ? n.body : (n.body? JSON.stringify(n.body):''),
            'BODY'
          );
          b.setFieldValue((n.save_to && n.save_to.scope) || 'chat', 'SCOPE');
          b.setFieldValue((n.save_to && n.save_to.key) || 'resp', 'KEY');
          b.setFieldValue(n.json_path || '', 'JPATH');
          prev = chainTo(prev, b);
          break;
        }

        case 'wait_next': {
          const b = workspace.newBlock('wait_next');
          // 修复：下拉菜单的值是 'any' 或 'number'，而不是中文
          b.setFieldValue(n.expect === 'number' ? 'number' : 'any', 'EXPECT');
          b.setFieldValue(n.prompt || '', 'PROMPT');
          prev = chainTo(prev, b);

          // 等待后的 next 顺着主链拼上（编辑态可见性更好）
          (n.next||[]).forEach(nn => applyBasicSend(nn));

          // 关键修复：在这里跳出主循环，因为后续节点都属于 next 的范畴
          i = nodes.length; // 设置 i 到末尾来终止循环
          break;
        }

        default:
          console.warn('Unknown node type in rebuild:', n.type, n);
      }
    }

    offsetX += 340;
  });

  try{
    const hint = document.getElementById('hint');
    if(hint && !hint.innerText.includes('近似还原')) {
        hint.innerHTML += ' ｜ 本次从 <code>entries</code> 近似还原，保存一次后将精确还原。';
    }
  }catch(e){}
}

// ---------------- 编译 JSON ----------------
function toFlowJSON() {
  const blocks = workspace.getTopBlocks(true);
  const entries = [];
  blocks.forEach((b, bi)=>{
    if(b.type!=='on_command') return;
    const cmd = b.getFieldValue('CMD') || ('cmd'+(bi+1));
    const nodes = [];
    let cur = b; // 从入口块开始

    // Helper to process a chain of blocks
    const processChain = (startBlock) => {
        let chainNodes = [];
        let current = startBlock;
        while(current){
            switch(current.type){
                case 'send_text':
                  chainNodes.push({type:'send_text', text: current.getFieldValue('TEXT'), parse_mode: current.getFieldValue('PARSE') || '', disable_preview: (current.getFieldValue('NOPREVIEW') === 'TRUE')});
                  break;
                case 'send_photo':
                  chainNodes.push({type:'send_photo', url: current.getFieldValue('URL'), caption: current.getFieldValue('CAP')});
                  break;
                case 'send_document':
                  chainNodes.push({type:'send_document', url: current.getFieldValue('URL'), caption: current.getFieldValue('CAP')});
                  break;
                case 'send_animation':
                  chainNodes.push({type:'send_animation', url: current.getFieldValue('URL'), caption: current.getFieldValue('CAP')});
                  break;
                case 'send_voice':
                  chainNodes.push({type:'send_voice', url: current.getFieldValue('URL'), caption: current.getFieldValue('CAP'), parse_mode: current.getFieldValue('PARSE') || ''});
                  break;
                case 'send_sticker':
                  chainNodes.push({type:'send_sticker', file_id: current.getFieldValue('FILE')});
                  break;
                case 'send_text_keyboard':
                  chainNodes.push({type:'send_text_keyboard', text: current.getFieldValue('TEXT'), keyboard: current.getFieldValue('KB'), parse_mode: current.getFieldValue('PARSE') || '', disable_preview: (current.getFieldValue('NOPREVIEW') === 'TRUE')});
                  break;
                case 'set_var_rand':
                  chainNodes.push({type:'set_var', mode:'random', scope: current.getFieldValue('SCOPE'), key: current.getFieldValue('KEY'), random:{min:Number(current.getFieldValue('MIN')), max:Number(current.getFieldValue('MAX'))}});
                  break;
                case 'set_var_val':
                  chainNodes.push({type:'set_var', mode:'text', scope: current.getFieldValue('SCOPE'), key: current.getFieldValue('KEY'), value: current.getFieldValue('VAL')});
                  break;
                case 'inc_var':
                  chainNodes.push({type:'inc_var', scope: current.getFieldValue('SCOPE'), key: current.getFieldValue('KEY'), step: Number(current.getFieldValue('STEP')||1)});
                  break;
                case 'get_var':
                  chainNodes.push({type:'get_var', scope: current.getFieldValue('SCOPE'), key: current.getFieldValue('KEY'), alias: current.getFieldValue('ALIAS')});
                  break;
                case 'set_local_from_input':
                  chainNodes.push({type:'set_local_from_input', alias: current.getFieldValue('ALIAS')});
                  break;
                case 'if_var':
                  const thenBranch = processChain(current.getInputTargetBlock('THEN'));
                  const elseBranch = processChain(current.getInputTargetBlock('ELSE'));
                  chainNodes.push({type:'if_var', op: current.getFieldValue('OP'), left:{var:current.getFieldValue('LHS')}, right:{text:current.getFieldValue('RHS')}, then: thenBranch, else: elseBranch});
                  break;
                case 'wait_next':
                  // This is a terminal block for this chain
                  const nextBranch = processChain(current.getNextBlock());
                  chainNodes.push({type:'wait_next', expect: (current.getFieldValue('EXPECT')==='number'?'number':'any'), prompt: current.getFieldValue('PROMPT'), next: nextBranch});
                  return chainNodes; // End the chain here
                case 'http_block':
                  chainNodes.push({type:'http', method:current.getFieldValue('METHOD'), url:current.getFieldValue('URL'), headers:current.getFieldValue('HEAD'), body:current.getFieldValue('BODY'), save_to:{scope:current.getFieldValue('SCOPE'), key:current.getFieldValue('KEY')}, json_path:current.getFieldValue('JPATH')});
                  break;
                case 'delay_seconds':
                  chainNodes.push({type:'delay', seconds: Number(current.getFieldValue('SEC')||0)});
                  break;
            }
            current = current.getNextBlock();
        }
        return chainNodes;
    };

    const nodes_list = processChain(b.getNextBlock());

    entries.push({id:`e${entries.length+1}`, type:'on_command', command:`/${cmd}`, nodes: nodes_list});
  });

  // 关键修复：使用新的JSON序列化API来保存工作区状态
  const workspaceState = Blockly.serialization.workspaces.save(workspace);
  return {version:1, entries, __workspaceState: workspaceState};
}


// ---------------- 保存 & 发布 ----------------
async function saveFlow(){
  if(!botId){ alert('缺少 bot_id'); return; }
  const name = prompt('流程名称：', '自定义流程');
  if(!name) return;

  const compiled = toFlowJSON();
  const r = await fetch(`/api/bots/${botId}/flows`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify({ id: flowId ? Number(flowId) : undefined, name, blocks_json: JSON.stringify(compiled) })
  });
  const j = await r.json();
  if(!j.ok){ alert('保存失败: ' + (j.error || '未知错误')); return; }

  await fetch(`/api/bots/${botId}/start`, { method:'POST', credentials:'same-origin' });
  alert('已保存并发布');
  if(window.opener && !window.opener.closed){
    try{ window.opener.loadFlows && window.opener.loadFlows(); }catch(e){}
  }
}

// ---------------- 打开时回填 ----------------
async function loadFlowForEdit(){
  if(!botId) {
     const on = workspace.newBlock('on_command'); on.initSvg(); on.render(); on.moveBy(20,20);
     return;
  }
  if(!flowId){
    const on = workspace.newBlock('on_command'); on.initSvg(); on.render(); on.moveBy(20,20);
    return;
  }

  const r = await fetch(`/api/bots/${botId}/flows`, { credentials:'same-origin' });
  const j = await r.json();
  const item = (j.items||[]).find(x=>String(x.id)===String(flowId));
  if(!item){
     console.warn('找不到 flow 记录');
     const on = workspace.newBlock('on_command'); on.initSvg(); on.render(); on.moveBy(20,20);
     return;
  }

  let compiled = item.blocks_compiled || safeParseBlocksJson(item.blocks_json);

  // 关键修复：优先使用新的 __workspaceState (JSON) 来加载
  if(compiled && compiled.__workspaceState){
    try{
      Blockly.serialization.workspaces.load(compiled.__workspaceState, workspace);
      return;
    } catch(e){
      console.warn('JSON工作区状态还原失败，退回 entries 近似还原：', e);
    }
  }

  // 后备方案：如果只有旧的 entries 数据，则尝试近似重建
  if(compiled && compiled.entries){
    rebuildFromCompiled(compiled);
    return;
  }

  // 如果完全没有可用的数据，创建一个默认的入口块
  const on = workspace.newBlock('on_command'); on.initSvg(); on.render(); on.moveBy(20,20);
}

document.getElementById('saveBtn').addEventListener('click', saveFlow);
loadFlowForEdit();
</script>
</body>
</html>