<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bot ç®¡ç†å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤–</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    @keyframes fade-in-up {
      0% { opacity: 0; transform: translateY(16px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .animate-card { animation: fade-in-up 0.4s ease-out both; }
    .panel-tab {
      padding: 0.375rem 0.75rem;
      border-radius: 0.75rem;
      background-color: #f3f4f6;
      color: #4b5563;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
    }
    .panel-tab:hover {
      background-color: #e5e7eb;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(148,163,184,0.25);
    }
    .panel-tab.active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      box-shadow: 0 12px 24px rgba(99,102,241,0.35);
    }
    .panel-surface {
      transition: opacity 0.2s ease;
    }
    .group-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .group-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 28px rgba(148,163,184,0.25);
    }
    .soft-pop {
      animation: fade-in-up 0.32s ease-out both;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-semibold mb-4">ğŸ¤– Bot ç®¡ç†å°ï¼ˆMVPï¼‰</h1>

    <!-- æœªç™»å½•è§†å›¾ -->
    <div id="auth" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="font-medium text-lg mb-2">ç™»å½•</h2>
        <div class="space-y-3">
          <input id="login_user" class="w-full border rounded-md px-3 py-2" placeholder="ç”¨æˆ·å" />
          <input id="login_pass" class="w-full border rounded-md px-3 py-2" placeholder="å¯†ç " type="password" />
          <button onclick="login()" class="px-4 py-2 rounded-md bg-black text-white">ç™»å½•</button>
          <div id="login_msg" class="text-sm text-red-500"></div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <h2 class="font-medium text-lg mb-2">æ³¨å†Œ</h2>
        <div class="space-y-3">
          <input id="reg_user" class="w-full border rounded-md px-3 py-2" placeholder="ç”¨æˆ·å" />
          <input id="reg_pass" class="w-full border rounded-md px-3 py-2" placeholder="å¯†ç " type="password" />
          <button onclick="registerUser()" class="px-4 py-2 rounded-md bg-indigo-600 text-white">æ³¨å†Œ</button>
          <div id="reg_msg" class="text-sm text-red-500"></div>
        </div>
      </div>
    </div>

    <!-- å·²ç™»å½•è§†å›¾ -->
    <div id="app" class="hidden space-y-6">
      <div class="flex items-center justify-between">
        <div id="welcome" class="text-gray-700"></div>
        <button onclick="logout()" class="text-sm px-3 py-1.5 rounded-md bg-gray-200 hover:bg-gray-300">é€€å‡ºç™»å½•</button>
      </div>

      <!-- Bot åˆ—è¡¨ -->
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between mb-4">
          <div>
            <h2 class="font-medium text-lg">æˆ‘çš„ Bots</h2>
            <p class="text-sm text-gray-500">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…ï¼Œå¯ç›´æ¥ä»åˆ—è¡¨å¯åŠ¨/åœæ­¢ã€‚</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 w-full md:w-auto">
            <input id="new_bot_name" class="border rounded-md px-3 py-1.5" placeholder="bot åç§°">
            <input id="new_bot_token" class="border rounded-md px-3 py-1.5" placeholder="BotFather token">
            <button onclick="addBot()" class="px-3 py-1.5 rounded-md bg-green-600 text-white transition-transform duration-200 hover:-translate-y-0.5 hover:shadow">æ·»åŠ </button>
          </div>
        </div>
        <div id="bot_cards" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
      </div>

      <!-- Bot æ§åˆ¶ä¸­å¿ƒ -->
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
          <div>
            <h2 class="font-medium text-lg">Bot æ§åˆ¶ä¸­å¿ƒ <span id="current_bot" class="text-gray-500 text-sm"></span></h2>
            <p class="text-xs text-gray-400">æ‰€æœ‰å›ºå®šæŒ‡ä»¤ã€æµç¨‹ä¸ä¼ªä»£ç é›†ä¸­ç®¡ç†ã€‚</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="startBot()" class="px-3 py-1.5 rounded-md bg-black text-white transition hover:-translate-y-0.5 hover:shadow">å¯åŠ¨/é‡è½½</button>
            <button onclick="stopBot()" class="px-3 py-1.5 rounded-md bg-gray-800 text-white transition hover:-translate-y-0.5 hover:shadow">åœæ­¢</button>
            <button onclick="syncMenu()" class="px-3 py-1.5 rounded-md bg-gray-200 transition hover:bg-gray-300">åŒæ­¥èœå•</button>
            <button onclick="openBlocks()" class="px-3 py-1.5 rounded-md bg-amber-500 text-white transition hover:-translate-y-0.5 hover:shadow">ç§¯æœ¨ç¼–æ’</button>
          </div>
        </div>
        <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-100 pb-3">
          <button data-panel="commands" class="panel-tab active">å›ºå®šæŒ‡ä»¤</button>
          <button data-panel="flows" class="panel-tab">æµç¨‹ç¼–æ’</button>
          <button data-panel="pseudo" class="panel-tab">ä¸­æ–‡ä¼ªä»£ç </button>
          <button data-panel="pro" class="panel-tab">ä¸“ä¸šæ¨¡å¼</button>
        </div>

        <div id="panel-commands" class="panel-surface">
          <details class="rounded-xl border border-gray-200 bg-gray-50 p-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>æ·»åŠ æˆ–æ›´æ–°å›ºå®šæŒ‡ä»¤</span>
              <span class="text-xs text-gray-400">å¡«å†™åç‚¹å‡»ä¸‹æ–¹ä¿å­˜</span>
            </summary>
            <div class="grid md:grid-cols-6 gap-2 mt-3 items-center">
              <input id="cmd" class="border rounded-md px-3 py-2 w-full md:col-span-2" placeholder="/ping">
              <select id="kind" class="border rounded-md px-3 py-2">
                <option value="text">æ–‡æœ¬</option>
                <option value="photo">å›¾ç‰‡</option>
                <option value="document">æ–‡æ¡£</option>
                <option value="animation">åŠ¨ç”»/GIF</option>
              </select>
              <input id="reply" class="border rounded-md px-3 py-2 md:col-span-3" placeholder="æ–‡æœ¬ï¼šæ”¯æŒ {{args}} ç­‰å˜é‡ï¼›åª’ä½“ï¼šå¯åš caption">
              <input id="media_url" class="border rounded-md px-3 py-2 md:col-span-3 hidden" placeholder="åª’ä½“ URLï¼ˆphoto/document/animation ä½¿ç”¨ï¼‰">
              <select id="cmd_group" class="border rounded-md px-3 py-2 md:col-span-2">
                <option value="">åˆ†ç»„ï¼šæœªæŒ‡å®š</option>
              </select>
              <select id="parse_mode" class="border rounded-md px-3 py-2">
                <option value="">ParseMode: None</option>
                <option value="MarkdownV2">MarkdownV2</option>
                <option value="HTML">HTML</option>
              </select>
              <label class="inline-flex items-center gap-2">
                <input id="no_preview" type="checkbox"> <span class="text-sm text-gray-600">ç¦ç”¨é“¾æ¥é¢„è§ˆ</span>
              </label>
              <button onclick="saveCmd()" class="px-3 py-2 rounded-md bg-indigo-600 text-white md:col-start-6">ä¿å­˜ / æ›´æ–°</button>
              <button onclick="eraseAll()" class="px-3 py-2 rounded-md bg-gray-200 md:col-start-6">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
          </details>
          <div class="flex flex-col md:flex-row gap-2 mt-4 mb-2">
            <input id="cmd_ai_prompt" class="flex-1 border rounded-md px-3 py-2" placeholder="ç”¨ä¸€å¥è¯æè¿°æƒ³è¦çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šæ¬¢è¿è®¿å®¢">
            <button onclick="aiGenerateCommand()" class="px-3 py-2 rounded-md bg-purple-600 text-white transition hover:-translate-y-0.5 hover:shadow">AI ç”ŸæˆæŒ‡ä»¤</button>
          </div>
          <p class="text-xs text-gray-400 mb-3">æç¤ºï¼šè‹¥å·²é…ç½® <code>DEEPSEEK_API_KEY</code> æˆ– <code>AI_API_KEY</code>ï¼Œå°†è°ƒç”¨ DeepSeek AIï¼›å¦åˆ™ä½¿ç”¨å†…ç½®æ¨¡æ¿ã€‚</p>
          <details class="rounded-xl border border-indigo-100 bg-white/80 p-4 mb-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>æŒ‡ä»¤åˆ†ç»„</span>
              <span class="text-xs text-gray-400">å¯ä¸ºå›ºå®šæŒ‡ä»¤å»ºç«‹ä¸»é¢˜åˆ†ç»„å¹¶é›†ä¸­å¯åœ</span>
            </summary>
            <div class="mt-3">
              <div id="group-list-commands" class="grid gap-3 md:grid-cols-2"></div>
            </div>
            <div class="grid md:grid-cols-4 gap-3 mt-4">
              <input type="hidden" id="group_form_commands_id">
              <input id="group_form_commands_name" class="border rounded-md px-3 py-2 md:col-span-2" placeholder="åˆ†ç»„åç§°ï¼Œä¾‹å¦‚ï¼šæ¬¢è¿ä¸é—®å€™">
              <textarea id="group_form_commands_desc" class="border rounded-md px-3 py-2 md:col-span-2 h-20" placeholder="åˆ†ç»„è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"></textarea>
              <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" id="group_form_commands_active" checked> å¯ç”¨åˆ†ç»„
              </label>
              <div class="flex gap-2 md:col-span-3">
                <button onclick="saveGroup('commands')" class="px-3 py-2 rounded-md bg-indigo-600 text-white transition hover:-translate-y-0.5 hover:shadow">ä¿å­˜åˆ†ç»„</button>
                <button onclick="resetGroupForm('commands')" class="px-3 py-2 rounded-md bg-gray-100 text-gray-700 transition hover:bg-gray-200">é‡ç½®</button>
              </div>
              <div id="group_form_commands_status" class="text-xs text-indigo-500 md:col-span-4"></div>
            </div>
          </details>
          <div id="cmd_cards" class="grid gap-3 md:grid-cols-2 xl:grid-cols-3"></div>
        </div>
         <div id="panel-pro" class="panel-surface hidden">
          <details class="rounded-xl border border-gray-200 bg-gray-50 p-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>ç¼–å†™ Python è„šæœ¬ (Pro)</span>
              <span class="text-xs text-gray-400">ç›´æ¥æ§åˆ¶ bot, update, context å¯¹è±¡</span>
            </summary>
            <div class="grid md:grid-cols-4 gap-3 mt-3">
              <input id="pro_name" class="border rounded-md px-3 py-2 md:col-span-2" placeholder="è„šæœ¬åç§°ï¼Œä¾‹å¦‚ï¼šæ¯æ—¥ç®€æŠ¥">
              <input id="pro_command" class="border rounded-md px-3 py-2 md:col-span-2" placeholder="è§¦å‘å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š/daily">
              <textarea id="pro_code" class="code-editor border rounded-md px-3 py-2 md:col-span-4 h-48" placeholder="# ä½ çš„ä»£ç ä¼šåŒ…è£…åœ¨ async def handler(bot, update, context, log) ä¸­&#10;# log('hello')&#10;await update.message.reply_text(f'Hello, {update.effective_user.first_name}')"></textarea>
              <input type="hidden" id="pro_id">
              <select id="pro_group" class="border rounded-md px-3 py-2 md:col-span-2">
                <option value="">åˆ†ç»„ï¼šæœªæŒ‡å®š</option>
              </select>
              <div class="flex items-center justify-between md:col-span-4">
                <label class="inline-flex items-center gap-2"><input id="pro_active" type="checkbox" checked> <span class="text-sm text-gray-600">å¯ç”¨</span></label>
                <div class="flex gap-2">
                  <button onclick="saveProScript()" class="px-4 py-2 rounded-md bg-indigo-600 text-white">ä¿å­˜è„šæœ¬</button>
                  <button onclick="resetProForm()" class="px-3 py-2 rounded-md bg-gray-200">æ¸…ç©ºè¡¨å•</button>
                </div>
              </div>
            </div>
          </details>
          <div id="pro_status" class="text-sm text-gray-600 my-3"></div>
          <table class="w-full text-sm">
            <thead><tr class="text-left text-gray-500"><th class="py-2 w-32">åç§°</th><th class="w-32">å‘½ä»¤</th><th class="w-32">åˆ†ç»„</th><th>ä»£ç æ‘˜è¦</th><th class="w-24">çŠ¶æ€</th><th class="w-32">æ“ä½œ</th></tr></thead>
            <tbody id="pro_scripts_table"></tbody>
          </table>
          <details class="rounded-xl border border-indigo-100 bg-white/80 p-4 mt-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>Pro è„šæœ¬åˆ†ç»„</span>
              <span class="text-xs text-gray-400">ç®¡ç†è„šæœ¬é›†åˆçš„å¯åœä¸è¯´æ˜</span>
            </summary>
            <div class="mt-3">
              <div id="group-list-pro" class="grid gap-3 md:grid-cols-2"></div>
            </div>
            <div class="grid md:grid-cols-4 gap-3 mt-4">
              <input type="hidden" id="group_form_pro_id">
              <input id="group_form_pro_name" class="border rounded-md px-3 py-2 md:col-span-2" placeholder="åˆ†ç»„åç§°ï¼Œä¾‹å¦‚ï¼šåå°ç»´æŠ¤">
              <textarea id="group_form_pro_desc" class="border rounded-md px-3 py-2 md:col-span-2 h-20" placeholder="åˆ†ç»„è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"></textarea>
              <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" id="group_form_pro_active" checked> å¯ç”¨åˆ†ç»„
              </label>
              <div class="flex gap-2 md:col-span-3">
                <button onclick="saveGroup('pro_scripts')" class="px-3 py-2 rounded-md bg-indigo-600 text-white transition hover:-translate-y-0.5 hover:shadow">ä¿å­˜åˆ†ç»„</button>
                <button onclick="resetGroupForm('pro_scripts')" class="px-3 py-2 rounded-md bg-gray-100 text-gray-700 transition hover:bg-gray-200">é‡ç½®</button>
              </div>
              <div id="group_form_pro_status" class="text-xs text-indigo-500 md:col-span-4"></div>
            </div>
          </details>
        </div>
        <div id="panel-flows" class="panel-surface hidden">
          <details class="rounded-xl border border-gray-200 bg-gray-50 p-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>æµç¨‹æ“ä½œ</span>
              <span class="text-xs text-gray-400">ç®¡ç† Blockly æµç¨‹ç¼–æ’</span>
            </summary>
            <div class="flex flex-wrap gap-2 mt-3">
              <button onclick="openBlocks()" class="px-3 py-1.5 rounded-md bg-amber-500 text-white transition hover:-translate-y-0.5 hover:shadow">æ‰“å¼€ Blockly ç¼–è¾‘å™¨</button>
              <button onclick="publishFlows()" class="px-3 py-1.5 rounded-md bg-gray-800 text-white transition hover:-translate-y-0.5 hover:shadow">å‘å¸ƒ / é‡è½½</button>
            </div>
          </details>
          <p class="text-xs text-gray-400 mt-3 mb-3">æç¤ºï¼šBlockly ä¸­ä¿å­˜åä¼šå›å†™åˆ°æ•°æ®åº“ï¼Œå†ç‚¹å‡»â€œå‘å¸ƒâ€å³å¯è®©è¿è¡Œä¸­çš„ Bot é‡è½½æœ€æ–°æµç¨‹ã€‚</p>
          <details class="rounded-xl border border-emerald-100 bg-white/80 p-4 mb-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>æµç¨‹åˆ†ç»„</span>
              <span class="text-xs text-gray-400">æ‰¹é‡å¯åœå¤æ‚æµç¨‹é›†åˆ</span>
            </summary>
            <div class="mt-3">
              <div id="group-list-flows" class="grid gap-3 md:grid-cols-2"></div>
            </div>
            <div class="grid md:grid-cols-4 gap-3 mt-4">
              <input type="hidden" id="group_form_flows_id">
              <input id="group_form_flows_name" class="border rounded-md px-3 py-2 md:col-span-2" placeholder="åˆ†ç»„åç§°ï¼Œä¾‹å¦‚ï¼šå”®å‰æµç¨‹">
              <textarea id="group_form_flows_desc" class="border rounded-md px-3 py-2 md:col-span-2 h-20" placeholder="åˆ†ç»„è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"></textarea>
              <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" id="group_form_flows_active" checked> å¯ç”¨åˆ†ç»„
              </label>
              <div class="flex gap-2 md:col-span-3">
                <button onclick="saveGroup('flows')" class="px-3 py-2 rounded-md bg-emerald-600 text-white transition hover:-translate-y-0.5 hover:shadow">ä¿å­˜åˆ†ç»„</button>
                <button onclick="resetGroupForm('flows')" class="px-3 py-2 rounded-md bg-gray-100 text-gray-700 transition hover:bg-gray-200">é‡ç½®</button>
              </div>
              <div id="group_form_flows_status" class="text-xs text-emerald-500 md:col-span-4"></div>
            </div>
          </details>
          <div id="flow_cards" class="grid gap-3 md:grid-cols-2 xl:grid-cols-3"></div>
        </div>

        <div id="panel-pseudo" class="panel-surface hidden">
          <details class="rounded-xl border border-gray-200 bg-gray-50 p-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>ç¼–å†™ / ç¼–è¾‘ä¸­æ–‡ä¼ªä»£ç </span>
              <span class="text-xs text-gray-400">æ”¯æŒ AI ç”Ÿæˆä¸æ²™ç›’æ¼”ç»ƒ</span>
            </summary>
            <div class="grid md:grid-cols-4 gap-3 mt-3">
              <input id="pseudo_title" class="border rounded-md px-3 py-2 md:col-span-1" placeholder="æ ‡é¢˜ï¼Œä¾‹å¦‚ï¼šæ¬¢è¿æµç¨‹ä¼ªä»£ç ">
              <textarea id="pseudo_content" class="border rounded-md px-3 py-2 md:col-span-3 h-32" placeholder="ä½¿ç”¨ä¸­æ–‡ä¼ªä»£ç æè¿° Bot è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š
1. ç”¨æˆ·å‘é€ /start
2. æœºå™¨äººå‘é€æ¬¢è¿æ–‡æœ¬..." ></textarea>
              <select id="pseudo_group" class="border rounded-md px-3 py-2 md:col-span-1">
                <option value="">åˆ†ç»„ï¼šæœªæŒ‡å®š</option>
              </select>
              <input type="hidden" id="pseudo_id">
              <div class="flex gap-2 md:col-start-4">
                <button onclick="savePseudocode()" class="flex-1 px-3 py-2 rounded-md bg-indigo-600 text-white">ä¿å­˜/æ›´æ–°ä¼ªä»£ç </button>
                <button onclick="resetPseudoForm()" class="px-3 py-2 rounded-md bg-gray-200">æ¸…ç©º</button>
              </div>
            </div>
          </details>
          <div class="flex flex-col md:flex-row gap-2 mb-3">
            <input id="pseudo_ai_prompt" class="flex-1 border rounded-md px-3 py-2" placeholder="è¾“å…¥éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šç”Ÿæˆæ¬¢è¿æµç¨‹">
            <button onclick="aiGeneratePseudo()" class="px-3 py-2 rounded-md bg-purple-600 text-white transition hover:-translate-y-0.5 hover:shadow">AI ç”Ÿæˆä¼ªä»£ç </button>
          </div>
          <p class="text-xs text-gray-400 mb-3">æç¤ºï¼šè‹¥å·²é…ç½® <code>DEEPSEEK_API_KEY</code> æˆ– <code>AI_API_KEY</code>ï¼Œå°†è°ƒç”¨ DeepSeek AIï¼›å¦åˆ™ä½¿ç”¨ç¦»çº¿æ¨¡æ¿å¿«é€Ÿå¡«å……ã€‚</p>
          <div id="pseudo_status" class="text-sm text-gray-600 mb-3"></div>
          <div class="flex flex-col md:flex-row gap-2 mb-3">
            <input id="sandbox_input" class="flex-1 border rounded-md px-3 py-2" placeholder="æ²™ç›’æ¨¡æ‹Ÿè¾“å…¥ï¼Œä¾‹å¦‚ï¼š/start æˆ– 1">
            <button onclick="sandboxPseudo(document.getElementById('pseudo_id').value||null)" class="px-3 py-2 rounded-md bg-slate-800 text-white transition hover:-translate-y-0.5 hover:shadow">å¯¹å½“å‰å†…å®¹æ²™ç›’æ¼”ç»ƒ</button>
          </div>
          <table class="w-full text-sm">
            <thead><tr class="text-left text-gray-500"><th class="py-2 w-16">ID</th><th class="w-48">æ ‡é¢˜</th><th>å†…å®¹æ‘˜è¦</th><th class="w-32">åˆ†ç»„</th><th class="w-20">çŠ¶æ€</th><th class="w-56">æ“ä½œ</th></tr></thead>
            <tbody id="pseudocode_table"></tbody>
          </table>
          <details class="rounded-xl border border-indigo-100 bg-white/80 p-4 mt-4" open>
            <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-gray-700">
              <span>ä¼ªä»£ç åˆ†ç»„</span>
              <span class="text-xs text-gray-400">ç»„ç»‡ä¼ªä»£ç è‰ç¨¿ï¼Œä¾¿äºæ‰¹é‡å¯åœ</span>
            </summary>
            <div class="mt-3">
              <div id="group-list-pseudo" class="grid gap-3 md:grid-cols-2"></div>
            </div>
            <div class="grid md:grid-cols-4 gap-3 mt-4">
              <input type="hidden" id="group_form_pseudo_id">
              <input id="group_form_pseudo_name" class="border rounded-md px-3 py-2 md:col-span-2" placeholder="åˆ†ç»„åç§°ï¼Œä¾‹å¦‚ï¼šæ¨¡æ¿è‰ç¨¿">
              <textarea id="group_form_pseudo_desc" class="border rounded-md px-3 py-2 md:col-span-2 h-20" placeholder="åˆ†ç»„è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"></textarea>
              <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" id="group_form_pseudo_active" checked> å¯ç”¨åˆ†ç»„
              </label>
              <div class="flex gap-2 md:col-span-3">
                <button onclick="saveGroup('pseudocode')" class="px-3 py-2 rounded-md bg-indigo-600 text-white transition hover:-translate-y-0.5 hover:shadow">ä¿å­˜åˆ†ç»„</button>
                <button onclick="resetGroupForm('pseudocode')" class="px-3 py-2 rounded-md bg-gray-100 text-gray-700 transition hover:bg-gray-200">é‡ç½®</button>
              </div>
              <div id="group_form_pseudo_status" class="text-xs text-indigo-500 md:col-span-4"></div>
            </div>
          </details>
          <div class="mt-4">
            <h4 class="text-sm font-medium text-gray-600 mb-2">æ²™ç›’æ¼”ç»ƒè¾“å‡º</h4>
            <pre id="sandbox_output" class="hidden bg-slate-900 text-sky-200 text-xs rounded-lg p-3 leading-5 whitespace-pre-wrap"></pre>
          </div>
        </div>

        <div id="status" class="text-sm text-gray-600 mt-4"></div>
      </div>

      <!-- ç¨‹åºæ€»è§ˆ -->
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium text-lg">ç¨‹åºæ€»è§ˆ</h2>
          <div class="flex items-center gap-2 text-sm">
            <span class="text-gray-400">å¿«é€Ÿå¤æŸ¥æŒ‡ä»¤ / æµç¨‹ / ä¼ªä»£ç </span>
            <button onclick="refreshOverview()" class="px-3 py-1.5 rounded-md bg-gray-200 hover:bg-gray-300">åˆ·æ–°</button>
          </div>
        </div>
        <div id="overview_content" class="space-y-4 text-sm text-gray-700">
          <div class="text-gray-500">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆé€‰æ‹© Bot å¹¶åŠ è½½é…ç½®ã€‚</div>
        </div>
      </div>

      <!-- è¿è¡Œç›‘æ§ -->
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium text-lg">è¿è¡Œç›‘æ§</h2>
          <div class="space-x-2">
            <button onclick="refreshStatus()" class="px-3 py-1.5 rounded-md bg-gray-200">ç«‹å³åˆ·æ–°</button>
          </div>
        </div>
        <div id="runtime_summary" class="text-sm text-gray-700 mb-3"></div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-medium text-gray-600 mb-2">å½“å‰ Bot çŠ¶æ€</h3>
            <table class="w-full text-sm">
              <tbody id="status_table"></tbody>
            </table>
          </div>
          <div>
            <h3 class="font-medium text-gray-600 mb-2">æœ€è¿‘æ—¥å¿—</h3>
            <pre id="log_box" class="bg-black text-green-200 text-xs p-3 rounded-md h-64 overflow-auto"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
let currentUser=null, currentBotId=null, pseudoCache={}, statusCache={};
let socket=null, socketReady=false, statusReconnectTimer=null;
let _logTimer=null;
let _loadBotsPending = false;
let commandsCache=[], flowsCache=[], pseudocodeCache=[];
let proScriptsCache = [];
const featureGroups = {
  commands: [],
  flows: [],
  pro_scripts: [],
  pseudocode: [],
};
const GROUP_LABELS = {
  commands: 'å›ºå®šæŒ‡ä»¤',
  flows: 'æµç¨‹ç¼–æ’',
  pro_scripts: 'Pro è„šæœ¬',
  pseudocode: 'ä¸­æ–‡ä¼ªä»£ç ',
};
const GROUP_FORMS = {
  commands: {
    container: 'group-list-commands',
    id: 'group_form_commands_id',
    name: 'group_form_commands_name',
    desc: 'group_form_commands_desc',
    active: 'group_form_commands_active',
    status: 'group_form_commands_status',
  },
  flows: {
    container: 'group-list-flows',
    id: 'group_form_flows_id',
    name: 'group_form_flows_name',
    desc: 'group_form_flows_desc',
    active: 'group_form_flows_active',
    status: 'group_form_flows_status',
  },
  pro_scripts: {
    container: 'group-list-pro',
    id: 'group_form_pro_id',
    name: 'group_form_pro_name',
    desc: 'group_form_pro_desc',
    active: 'group_form_pro_active',
    status: 'group_form_pro_status',
  },
  pseudocode: {
    container: 'group-list-pseudo',
    id: 'group_form_pseudo_id',
    name: 'group_form_pseudo_name',
    desc: 'group_form_pseudo_desc',
    active: 'group_form_pseudo_active',
    status: 'group_form_pseudo_status',
  },
};
const fmt = {
  time(seconds){
    const sec = Number(seconds||0);
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = Math.floor(sec%60);
    return `${h}h ${m}m ${s}s`;
  },
  date(ts){
    if(!ts) return '-';
    try{
      return new Date(ts).toLocaleString();
    }catch(e){
      return ts;
    }
  }
};

function escapeHtml(str=''){
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

function prettyJson(obj){
  try{
    if(typeof obj === 'string'){
      const parsed = JSON.parse(obj);
      return JSON.stringify(parsed, null, 2);
    }
    return JSON.stringify(obj, null, 2);
  }catch(e){
    return String(obj);
  }
}

function parseMaybeJson(raw){
  if(!raw) return null;
  if(typeof raw === 'object') return raw;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

function parseFlowCompiled(raw){
  if(!raw) return null;
  let data = raw;
  if(typeof data === 'string'){
    try { data = JSON.parse(data); } catch(e){ return null; }
    if(typeof data === 'string'){
      try { data = JSON.parse(data); } catch(e){ return null; }
    }
  }
  return (data && typeof data === 'object') ? data : null;
}

function isActiveFlag(val){
  try {
    const n = Number(val);
    return Number.isNaN(n) ? !!val : n === 1;
  } catch(e){
    return !!val;
  }
}

function isGroupActive(flag){
  try {
    return Number(flag ?? 1) === 1;
  } catch(e){
    return !!flag;
  }
}

function isEffectivelyActive(item){
  if(!item) return false;
  if(Object.prototype.hasOwnProperty.call(item, 'effective_active')){
    return !!item.effective_active;
  }
  const active = !!item.active;
  if(!active) return false;
  return isGroupActive(item.group_active);
}

let botsCache=[];

function toggleDetails(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.toggle('hidden');
  el.classList.toggle('animate-card');
}

function normalizeGroupId(value){
  if(value === undefined || value === null) return null;
  if(typeof value === 'number' && Number.isFinite(value)){
    return value > 0 ? Math.trunc(value) : null;
  }
  const str = String(value).trim();
  if(!str || str.toLowerCase() === 'null') return null;
  const num = Number(str);
  if(Number.isFinite(num) && num > 0) return Math.trunc(num);
  return null;
}

function renderGroupOptions(kind, selected){
  const groups = featureGroups[kind] || [];
  let html = '<option value="">æ— åˆ†ç»„</option>';
  groups.forEach(g => {
    const flag = Number(g.active ?? 1) === 1;
    const sel = selected && Number(g.id) === Number(selected) ? 'selected' : '';
    const suffix = flag ? '' : 'ï¼ˆåœç”¨ï¼‰';
    html += `<option value="${g.id}" ${sel}>${escapeHtml(g.name)}${suffix}</option>`;
  });
  return html;
}

function refreshGroupSelects(kind){
  const selectMap = {
    commands: ['cmd_group'],
    pro_scripts: ['pro_group'],
    pseudocode: ['pseudo_group'],
  };
  const ids = selectMap[kind];
  if(!ids) return;
  ids.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    const current = normalizeGroupId(el.value);
    el.innerHTML = renderGroupOptions(kind, current);
    el.value = current ?? '';
  });
}

function renderGroupList(kind){
  const config = GROUP_FORMS[kind];
  if(!config) return;
  const container = document.getElementById(config.container);
  if(!container) return;
  const groups = featureGroups[kind] || [];
  if(!groups.length){
    container.innerHTML = `<div class="text-xs text-gray-400">æš‚æ— ${GROUP_LABELS[kind]}åˆ†ç»„ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªå§ï½</div>`;
    return;
  }
  container.innerHTML = groups.map(g => {
    const flag = Number(g.active ?? 1) === 1;
    const badgeClass = flag ? 'bg-emerald-100 text-emerald-600' : 'bg-gray-100 text-gray-500';
    const toggleText = flag ? 'åœç”¨' : 'å¯ç”¨';
    const toggleColor = flag ? 'text-amber-600 hover:text-amber-700' : 'text-emerald-600 hover:text-emerald-700';
    const desc = g.description ? `<p class="text-xs text-gray-500 mt-2">${escapeHtml(g.description)}</p>` : '';
    return `
      <div class="group-card soft-pop rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="flex items-center gap-2">
              <span class="font-medium text-gray-800">${escapeHtml(g.name)}</span>
              <span class="text-xs px-2 py-0.5 rounded-full ${badgeClass}">${flag ? 'å¯ç”¨' : 'åœç”¨'}</span>
            </div>
            <div class="text-xs text-gray-400 mt-1">åŒ…å« ${g.item_count || 0} é¡¹ï½œå¯ç”¨ ${g.active_item_count || 0} é¡¹</div>
            ${desc}
          </div>
          <div class="flex flex-col items-end gap-1 text-xs text-gray-400">
            <button class="text-indigo-600 hover:text-indigo-700" onclick="editGroup('${kind}', ${g.id})">ç¼–è¾‘</button>
            <button class="${toggleColor}" onclick="setFeatureGroupActive('${kind}', ${g.id}, ${flag ? 'false' : 'true'})">${toggleText}</button>
            <button class="text-red-500 hover:text-red-600" onclick="deleteGroup('${kind}', ${g.id})">åˆ é™¤</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

function groupStatus(kind, message){
  const config = GROUP_FORMS[kind];
  if(!config) return;
  const el = document.getElementById(config.status);
  if(el) el.innerText = message || '';
}

function resetGroupForm(kind){
  const config = GROUP_FORMS[kind];
  if(!config) return;
  const idEl = document.getElementById(config.id);
  const nameEl = document.getElementById(config.name);
  const descEl = document.getElementById(config.desc);
  const activeEl = document.getElementById(config.active);
  if(idEl) idEl.value = '';
  if(nameEl) nameEl.value = '';
  if(descEl) descEl.value = '';
  if(activeEl) activeEl.checked = true;
  groupStatus(kind, '');
}

function editGroup(kind, id){
  const groups = featureGroups[kind] || [];
  const config = GROUP_FORMS[kind];
  if(!config) return;
  const target = groups.find(item => Number(item.id) === Number(id));
  if(!target) return;
  document.getElementById(config.id).value = target.id;
  document.getElementById(config.name).value = target.name || '';
  document.getElementById(config.desc).value = target.description || '';
  document.getElementById(config.active).checked = Number(target.active ?? 1) === 1;
  groupStatus(kind, `âœï¸ ç¼–è¾‘åˆ†ç»„ï¼š${target.name}`);
}

async function saveGroup(kind){
  if(!currentBotId){ alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Bot'); return; }
  const config = GROUP_FORMS[kind];
  if(!config) return;
  const id = document.getElementById(config.id).value || undefined;
  const name = document.getElementById(config.name).value.trim();
  const description = document.getElementById(config.desc).value.trim();
  const active = document.getElementById(config.active).checked;
  if(!name){
    groupStatus(kind, 'âŒ è¯·è¾“å…¥åˆ†ç»„åç§°');
    return;
  }
  const payload = { name, description, active };
  if(id) payload.id = Number(id);
  const r = await fetch(`/api/bots/${currentBotId}/groups/${kind}`, {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload),
  });
  const j = await r.json();
  if(j.ok){
    groupStatus(kind, 'âœ… åˆ†ç»„å·²ä¿å­˜');
    resetGroupForm(kind);
    await loadFeatureGroups(kind);
    if(kind === 'commands') loadCmds();
    if(kind === 'flows') loadFlows();
    if(kind === 'pro_scripts') loadProScripts();
    if(kind === 'pseudocode') loadPseudocode();
  } else {
    groupStatus(kind, `âŒ ${j.error || 'ä¿å­˜å¤±è´¥'}`);
  }
}

async function loadFeatureGroups(kind){
  if(!currentBotId) return;
  const r = await fetch(`/api/bots/${currentBotId}/groups/${kind}`, { credentials:'same-origin' });
  const j = await r.json();
  featureGroups[kind] = j.items || [];
  renderGroupList(kind);
  refreshGroupSelects(kind);
}

async function loadAllGroups(){
  if(!currentBotId) return;
  await Promise.all([
    loadFeatureGroups('commands'),
    loadFeatureGroups('flows'),
    loadFeatureGroups('pro_scripts'),
    loadFeatureGroups('pseudocode'),
  ]);
}

async function setFeatureGroupActive(kind, groupId, active){
  const r = await fetch(`/api/bots/${currentBotId}/groups/${groupId}/active`, {
    method:'PATCH',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ active })
  });
  const j = await r.json();
  if(!j.ok){
    groupStatus(kind, `âŒ ${j.error || 'æ›´æ–°å¤±è´¥'}`);
    return;
  }
  await loadFeatureGroups(kind);
  if(kind === 'commands') loadCmds();
  if(kind === 'flows') loadFlows();
  if(kind === 'pro_scripts') loadProScripts();
  if(kind === 'pseudocode') loadPseudocode();
}

async function deleteGroup(kind, groupId){
  if(!confirm('ç¡®è®¤åˆ é™¤è¯¥åˆ†ç»„ï¼Ÿ\næç¤ºï¼šå·²å…³è”çš„æ¡ç›®ä¼šè‡ªåŠ¨è§£é™¤å…³è”ã€‚')) return;
  const r = await fetch(`/api/bots/${currentBotId}/groups/${groupId}`, {
    method:'DELETE',
    credentials:'same-origin'
  });
  const j = await r.json();
  if(!j.ok){
    groupStatus(kind, `âŒ ${j.error || 'åˆ é™¤å¤±è´¥'}`);
    return;
  }
  groupStatus(kind, 'ğŸ—‘ï¸ åˆ†ç»„å·²åˆ é™¤');
  await loadFeatureGroups(kind);
  if(kind === 'commands') loadCmds();
  if(kind === 'flows') loadFlows();
  if(kind === 'pro_scripts') loadProScripts();
  if(kind === 'pseudocode') loadPseudocode();
}

const panelSections = {
  commands: () => document.getElementById('panel-commands'),
  flows: () => document.getElementById('panel-flows'),
  pro: () => document.getElementById('panel-pro'), // æ–°å¢
  pseudo: () => document.getElementById('panel-pseudo'),
};

const panelTabs = Array.from(document.querySelectorAll('[data-panel]'));
let activePanel = 'commands';

function setActivePanel(name){
  if(!panelSections[name]) return;
  activePanel = name;
  Object.keys(panelSections).forEach(key => {
    const section = panelSections[key]();
    if(!section) return;
    if(key === name){
      section.classList.remove('hidden');
      section.classList.add('animate-card');
    } else {
      section.classList.add('hidden');
    }
  });
  panelTabs.forEach(btn => {
    const target = btn.dataset.panel;
    if(target === name){
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}

function commandPseudo(cmd){
  const lines = [];
  lines.push(`å½“ç”¨æˆ·å‘é€ ${cmd.command || ''}`);
  const kind = (cmd.kind || 'text').toLowerCase();
  if(kind === 'text'){
    const body = (cmd.reply || '').trim();
    lines.push(`  - æœºå™¨äººå›å¤æ–‡æœ¬ã€Œ${body || '...'}ã€`);
    if(cmd.parse_mode){
      lines.push(`  - ä½¿ç”¨ ParseMode=${cmd.parse_mode}`);
    }
    if(cmd.disable_preview){
      lines.push('  - ç¦ç”¨é“¾æ¥é¢„è§ˆ');
    }
  } else if(['photo','document','animation','voice'].includes(kind)){
    const payload = parseMaybeJson(cmd.payload) || {};
    const url = payload.url || payload.file_id || '';
    const caption = payload.caption || cmd.reply || '';
    const mediaLabel = {photo:'å›¾ç‰‡', document:'æ–‡æ¡£', animation:'åŠ¨ç”»', voice:'è¯­éŸ³'}[kind] || kind;
    lines.push(`  - æœºå™¨äººå‘é€${mediaLabel} ${url ? `(${url})` : ''}`.trim());
    if(caption){
      lines.push(`  - é™„å¸¦è¯´æ˜ã€Œ${caption}ã€`);
    }
  } else {
    lines.push(`  - æœºå™¨äººæ‰§è¡Œ ${kind} ç±»å‹åŠ¨ä½œ`);
  }
  return lines.join('\n');
}

function describeFlowNode(node){
  if(!node) return '  - ...(æœªçŸ¥èŠ‚ç‚¹)';
  const t = node.type;
  switch(t){
    case 'send_text':
      return `  - å‘é€æ–‡æœ¬ã€Œ${(node.text||'').slice(0,32)}ã€`;
    case 'send_photo':
      return `  - å‘é€å›¾ç‰‡ ${node.url ? '('+node.url+')' : ''}`.trim();
    case 'send_document':
      return `  - å‘é€æ–‡æ¡£ ${node.url ? '('+node.url+')' : ''}`.trim();
    case 'send_animation':
      return `  - å‘é€åŠ¨ç”»/GIF ${node.url ? '('+node.url+')' : ''}`.trim();
    case 'send_voice':
      return `  - å‘é€è¯­éŸ³ ${node.url ? '('+node.url+')' : ''}`.trim();
    case 'send_sticker':
      return `  - å‘é€è´´çº¸ ${node.file_id ? '('+node.file_id+')' : ''}`.trim();
    case 'send_text_keyboard':
      return '  - å‘é€æ–‡æœ¬å¹¶é™„å¸¦æŒ‰é’®';
    case 'set_var':
      if((node.mode||'')==='random'){
        const r = node.random || {};
        const rMin = r.min != null ? r.min : 1;
        const rMax = r.max != null ? r.max : 100;
        return `  - è®¾ç½® ${node.scope||'chat'} å˜é‡ ${node.key||'k'} ä¸ºéšæœº ${rMin}~${rMax}`;
      }
      return `  - è®¾ç½® ${node.scope||'chat'} å˜é‡ ${node.key||'k'} = ${node.value||''}`;
    case 'inc_var':
      return `  - ${node.scope||'chat'} å˜é‡ ${node.key||'count'} += ${node.step||1}`;
    case 'get_var':
      return `  - è¯»å– ${node.scope||'chat'} å˜é‡ ${node.key||'k'} â†’ ${node.alias||'x'}`;
    case 'set_local_from_input':
      return `  - å°†è¾“å…¥æ–‡æœ¬ä¿å­˜åˆ°ä¸´æ—¶å˜é‡ ${node.alias||'x'}`;
    case 'if_var':
      const leftVar = (node.left && node.left.var) || 'x';
      const rightText = (node.right && node.right.text) || '';
      return `  - æ¡ä»¶åˆ¤æ–­ï¼šlocal.${leftVar} ${node.op||'eq'} ${rightText}`;
    case 'wait_next':
      return `  - ç­‰å¾…ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼ˆæœŸæœ›${node.expect==='number'?'æ•°å­—':'ä»»æ„'}ï¼‰ï¼Œæç¤ºã€Œ${node.prompt||''}ã€`;
    case 'http':
      return `  - è¯·æ±‚ ${node.method||'GET'} ${node.url||''}`;
    case 'delay':
      return `  - å»¶è¿Ÿ ${node.seconds||0} ç§’åç»§ç»­`;
    default:
      return `  - èŠ‚ç‚¹ ${t}`;
  }
}

function flowPseudo(compiled){
  if(!compiled || !Array.isArray(compiled.entries)) return 'æš‚æ— ä¼ªä»£ç ï¼Œè¯·å…ˆä¿å­˜æµç¨‹ã€‚';
  const lines = [];
  for(const entry of compiled.entries){
    const cmd = entry.command || entry.name || 'å…¥å£';
    lines.push(`å½“è§¦å‘ ${cmd}ï¼š`);
    const nodes = entry.nodes || [];
    if(!nodes.length){
      lines.push('  - ï¼ˆæ— åŠ¨ä½œï¼‰');
    } else {
      nodes.forEach(n => {
        lines.push(describeFlowNode(n));
        if(n.type === 'if_var'){
          (n.then||[]).forEach(child => lines.push('    THEN ' + describeFlowNode(child).replace(/^\s+-\s+/, '')));
          (n.else||[]).forEach(child => lines.push('    ELSE ' + describeFlowNode(child).replace(/^\s+-\s+/, '')));
        }
        if(n.type === 'wait_next'){
          (n.next||[]).forEach(child => lines.push('    NEXT ' + describeFlowNode(child).replace(/^\s+-\s+/, '')));
        }
      });
    }
    lines.push('');
  }
  return lines.join('\n');
}

async function me(){
  const res = await fetch('/api/me',{credentials:'same-origin'});
  const data = await res.json();
  currentUser = data.user;
  document.getElementById('auth').classList.toggle('hidden', !!currentUser);
  document.getElementById('app').classList.toggle('hidden', !currentUser);
  if(currentUser){
    document.getElementById('welcome').innerText = `ä½ å¥½ï¼Œ${currentUser.username}`;
    await loadBots();
    connectStatusSocket();
    refreshStatus();
    if(_logTimer) clearInterval(_logTimer);
    _logTimer = setInterval(refreshStatus, 5000);
  } else {
    disconnectStatusSocket();
    if(_logTimer){ clearInterval(_logTimer); _logTimer = null; }
  }
}
async function registerUser(){
  const username=document.getElementById('reg_user').value.trim();
  const password=document.getElementById('reg_pass').value;
  const r=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify({username,password})});
  const j=await r.json(); document.getElementById('reg_msg').innerText=j.ok?'âœ… å·²æ³¨å†Œï¼Œå»ç™»å½•':'âŒ '+(j.error||'å¤±è´¥');
}
async function login(){
  const username=document.getElementById('login_user').value.trim();
  const password=document.getElementById('login_pass').value;
  const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify({username,password})});
  const j=await r.json(); document.getElementById('login_msg').innerText=j.ok?'':'âŒ '+(j.error||'å¤±è´¥'); await me();
}
async function logout(){ await fetch('/api/logout',{method:'POST',credentials:'same-origin'}); location.reload(); }

function connectStatusSocket(){
  if(!currentUser) return;
  if(socket){
    if(!socket.connected){ socket.connect(); }
    return;
  }
  socket = io('/', {transports:['websocket'], withCredentials:true});
  socket.on('connect', () => {
    socketReady = true;
    socket.emit('subscribe_status');
  });
  socket.on('disconnect', () => {
    socketReady = false;
    scheduleSocketReconnect();
  });
  socket.on('connect_error', (err) => {
    console.warn('socket connect error', err);
    scheduleSocketReconnect();
  });
  socket.on('auth_error', (payload) => {
    console.warn('socket auth error', payload);
  });
  socket.on('bot_status', payload => {
    applyStatusPayload(payload);
  });
}

function scheduleSocketReconnect(){
  if(statusReconnectTimer || !currentUser) return;
  statusReconnectTimer = setTimeout(() => {
    statusReconnectTimer = null;
    if(!currentUser) return;
    if(socket){
      if(!socket.connected){
        try { socket.connect(); } catch (err) { console.warn('socket reconnect failed', err); }
      }
    } else {
      connectStatusSocket();
    }
  }, 4000);
}

function disconnectStatusSocket(){
  if(statusReconnectTimer){
    clearTimeout(statusReconnectTimer);
    statusReconnectTimer = null;
  }
  if(socket){
    try { socket.disconnect(); } catch (err) { console.warn('socket disconnect error', err); }
    socket = null;
  }
  socketReady = false;
}

function applyStatusPayload(payload){
  const items = (payload && payload.items) || [];
  const keep = new Set();
  items.forEach(item => {
    const id = Number(item.bot_id);
    keep.add(id);
    statusCache[id] = item;
    const existing = botsCache.find(b => Number(b.id) === id);
    if(existing){
      if(item.name) existing.name = item.name;
      if(item.token_mask) existing.token_mask = item.token_mask;
    } else {
      botsCache.push({ id, name: item.name || `Bot #${id}`, token_mask: item.token_mask || '' });
    }
  });
  Object.keys(statusCache).forEach(key => {
    const id = Number(key);
    if(!keep.has(id)) delete statusCache[id];
  });
  renderBotCards();
  updateRuntimeSummary();
  if(currentBotId && statusCache[currentBotId]){
    updateStatusTable(statusCache[currentBotId]);
  }
}

function updateRuntimeSummary(){
  const wrap = document.getElementById('runtime_summary');
  if(!wrap) return;
  const items = Object.values(statusCache).filter(item =>
    botsCache.some(bot => Number(bot.id) === Number(item.bot_id))
  );
  if(!items.length){
    wrap.innerHTML = '<span class="text-sm text-gray-400">æš‚æ— å®æ—¶çŠ¶æ€</span>';
    return;
  }
  wrap.innerHTML = items.map(it => {
    const stats = it.stats || {};
    const label = escapeHtml(it.name || `Bot #${it.bot_id}`);
    const badgeClass = it.state === 'running' ? 'border-emerald-300' : 'border-gray-300';
    return `<span class="inline-block mr-2 mb-2 px-2 py-0.5 rounded border ${badgeClass}">${label} ${badge(it.state)} <span class="text-xs text-gray-500">m:${stats.messages||0}/e:${stats.errors||0}</span></span>`;
  }).join(' ');
}

function updateStatusTable(snapshot){
  const table = document.getElementById('status_table');
  if(!table) return;
  const stats = snapshot.stats || {};
  const lastErr = snapshot.last_error ? `<div class="text-red-600 truncate" title="${escapeHtml(snapshot.last_error)}">${escapeHtml(snapshot.last_error)}</div>` : '';
  table.innerHTML = `
    <tr class="border-t"><td class="py-1 pr-4 text-gray-500">State</td><td class="py-1">${badge(snapshot.state||'stopped')}</td></tr>
    <tr class="border-t"><td class="py-1 pr-4 text-gray-500">Uptime</td><td class="py-1">${fmt.time(snapshot.uptime||0)}</td></tr>
    <tr class="border-t"><td class="py-1 pr-4 text-gray-500">Messages</td><td class="py-1">${stats.messages||0}</td></tr>
    <tr class="border-t"><td class="py-1 pr-4 text-gray-500">Errors</td><td class="py-1">${stats.errors||0} ${lastErr}</td></tr>
    <tr class="border-t"><td class="py-1 pr-4 text-gray-500">Specs/Flows</td><td class="py-1">${snapshot.specs_count||0} / ${snapshot.flows_count||0}</td></tr>
  `;
}
async function loadBots(){
  if(_loadBotsPending) return botsCache;
  _loadBotsPending = true;
  try {
    const res = await fetch('/api/bots',{credentials:'same-origin'});
    const botsJson = await res.json();
    const bots = botsJson.items || [];
    botsCache = bots;
    const validIds = new Set(bots.map(b => Number(b.id)));
    Object.keys(statusCache).forEach(key => {
      if(!validIds.has(Number(key))) delete statusCache[key];
    });
    renderBotCards();
    updateRuntimeSummary();
    if(currentBotId && statusCache[currentBotId]){
      updateStatusTable(statusCache[currentBotId]);
    }
    if(bots.length){
      const existing = bots.find(b => Number(b.id) === Number(currentBotId));
      if(existing){
        document.getElementById('current_bot').innerText=`ï¼ˆå½“å‰ï¼š${existing.name} #${existing.id}ï¼‰`;
        highlightSelectedBot(existing.id);
      } else {
        selectBot(bots[0].id, bots[0].name);
      }
    } else {
      currentBotId = null;
      document.getElementById('current_bot').innerText='';
      document.getElementById('cmd_cards').innerHTML='';
      document.getElementById('flow_cards').innerHTML='';
      document.getElementById('runtime_summary').innerHTML='';
      document.getElementById('status_table').innerHTML='';
      commandsCache = [];
      flowsCache = [];
      pseudocodeCache = [];
      updateOverview();
    }
    return bots;
  } finally {
    _loadBotsPending = false;
  }
}

function renderBotCards() {
    const wrap = document.getElementById('bot_cards');
    if (!wrap) return;

    const bots = botsCache || [];
    const existingCardElements = wrap.querySelectorAll('.bot-card');
    const cardMap = new Map();
    existingCardElements.forEach(card => {
        const botId = card.dataset.botId;
        if (botId) {
            cardMap.set(String(botId), card);
        }
    });

    if (!bots.length) {
        wrap.innerHTML = '<div class="text-sm text-gray-500">æš‚æ—  Botï¼Œè¯·å…ˆåˆ›å»ºã€‚</div>';
        return;
    }

    bots.forEach(bot => {
        const snap = statusCache[bot.id] || {};
        const state = snap.state || 'stopped';
        const stats = snap.stats || { messages: 0, errors: 0 };
        const tokenMask = snap.token_mask || bot.token_mask || '';
        const displayName = escapeHtml(bot.name || `Bot #${bot.id}`);
        const safeName = (bot.name || `Bot #${bot.id}`).replace(/'/g, "\'");

        let card = cardMap.get(String(bot.id));

        if (card) {
            // --- å¡ç‰‡å·²å­˜åœ¨ï¼Œåªæ›´æ–°å˜åŒ–çš„æ–‡æœ¬å’Œæ ·å¼ ---
            // çŠ¶æ€å¾½ç« 
            const badgeEl = card.querySelector('.bot-status-badge');
            if (badgeEl) badgeEl.innerHTML = badge(state);
            // è¿è¡Œæ—¶é•¿
            const uptimeEl = card.querySelector('.bot-uptime');
            if (uptimeEl) uptimeEl.textContent = fmt.time(snap.uptime || 0);
            // æ¶ˆæ¯/é”™è¯¯æ•°
            const statsEl = card.querySelector('.bot-stats');
            if (statsEl) statsEl.textContent = `${stats.messages || 0} / ${stats.errors || 0}`;
            // å›ºå®šæŒ‡ä»¤æ•°
            const specsEl = card.querySelector('.bot-specs-count');
            if (specsEl) specsEl.textContent = snap.specs_count || 0;
            // æµç¨‹æ•°
            const flowsEl = card.querySelector('.bot-flows-count');
            if (flowsEl) flowsEl.textContent = snap.flows_count || 0;

            cardMap.delete(String(bot.id)); // ä»mapä¸­ç§»é™¤ï¼Œè¡¨ç¤ºå·²å¤„ç†
        } else {
            // --- å¡ç‰‡ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¡ç‰‡ ---
            card = document.createElement('div');
            card.className = 'bot-card animate-card rounded-2xl border border-gray-100 bg-gradient-to-br from-white via-white to-gray-50 shadow transition-all duration-300 hover:-translate-y-1 hover:shadow-xl';
            card.dataset.botId = bot.id;

            // ä¸ºéœ€è¦æ›´æ–°çš„å…ƒç´ æ·»åŠ ç‰¹å®šçš„classï¼Œæ–¹ä¾¿ä¹‹åæŸ¥æ‰¾
            card.innerHTML = `
              <div class="p-5 h-full flex flex-col gap-4" onclick="selectBot(${bot.id}, '${safeName}')">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="text-lg font-semibold text-gray-800">${displayName}</span>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">ID ${bot.id}</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Token: ${escapeHtml(tokenMask)}</p>
                  </div>
                  <div class="text-sm bot-status-badge">${badge(state)}</div>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm text-gray-600">
                  <div>
                    <div class="text-xs text-gray-400">è¿è¡Œæ—¶é•¿</div>
                    <div class="font-medium bot-uptime">${fmt.time(snap.uptime || 0)}</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-400">æ¶ˆæ¯ / é”™è¯¯</div>
                    <div class="font-medium bot-stats">${stats.messages || 0} / ${stats.errors || 0}</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-400">å›ºå®šæŒ‡ä»¤</div>
                    <div class="font-medium bot-specs-count">${snap.specs_count || 0}</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-400">æµç¨‹æ•°</div>
                    <div class="font-medium bot-flows-count">${snap.flows_count || 0}</div>
                  </div>
                </div>
                <div class="mt-auto flex flex-wrap gap-2 text-sm">
                  <button class="px-3 py-1.5 rounded-md bg-indigo-600 text-white transition hover:opacity-90" onclick="event.stopPropagation(); selectBot(${bot.id}, '${safeName}')">è¯¦æƒ…</button>
                  <button class="px-3 py-1.5 rounded-md bg-emerald-500 text-white transition hover:opacity-90" onclick="event.stopPropagation(); currentBotId=${bot.id}; startBot();">å¯åŠ¨</button>
                  <button class="px-3 py-1.5 rounded-md bg-gray-700 text-white transition hover:opacity-90" onclick="event.stopPropagation(); currentBotId=${bot.id}; stopBot();">åœæ­¢</button>
                  <button class="px-3 py-1.5 rounded-md bg-gray-200 transition hover:bg-gray-300" onclick="event.stopPropagation(); currentBotId=${bot.id}; syncMenu();">åŒæ­¥èœå•</button>
                  <button class="px-3 py-1.5 rounded-md bg-red-50 text-red-600 transition hover:bg-red-100" onclick="event.stopPropagation(); delBot(${bot.id});">åˆ é™¤</button>
                </div>
              </div>
            `;
            wrap.appendChild(card);
        }
    });

    // å¦‚æœ map ä¸­è¿˜æœ‰å‰©ä¸‹çš„å¡ç‰‡ï¼Œè¯´æ˜å®ƒä»¬å¯¹åº”çš„ bot å·²è¢«åˆ é™¤ï¼Œéœ€è¦ä» DOM ä¸­ç§»é™¤
    cardMap.forEach(card => card.remove());

    highlightSelectedBot(currentBotId);
}
function updateOverview(){
  const wrap = document.getElementById('overview_content');
  if(!wrap) return;
  const total = commandsCache.length + flowsCache.length + pseudocodeCache.length;
  if(total === 0){
    wrap.innerHTML = '<div class="text-gray-500">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåŠ è½½ Bot é…ç½®ã€‚</div>';
    return;
  }
  const activeCommands = commandsCache.filter(isEffectivelyActive).length;
  const activeFlows = flowsCache.filter(isEffectivelyActive).length;
  const activePseudos = pseudocodeCache.filter(isEffectivelyActive).length;
  const summary = `
    <div class="grid md:grid-cols-3 gap-3 text-xs text-gray-500 mb-3">
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <div class="text-xs uppercase tracking-wide text-gray-400">å›ºå®šæŒ‡ä»¤</div>
        <div class="text-lg font-semibold text-gray-800">${activeCommands} / ${commandsCache.length}</div>
        <div class="text-xs text-gray-400 mt-1">å·²å¯ç”¨ / æ€»æ•°</div>
      </div>
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <div class="text-xs uppercase tracking-wide text-gray-400">æµç¨‹ç¼–æ’</div>
        <div class="text-lg font-semibold text-gray-800">${activeFlows} / ${flowsCache.length}</div>
        <div class="text-xs text-gray-400 mt-1">å·²å¯ç”¨ / æ€»æ•°</div>
      </div>
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <div class="text-xs uppercase tracking-wide text-gray-400">ä¸­æ–‡ä¼ªä»£ç </div>
        <div class="text-lg font-semibold text-gray-800">${activePseudos} / ${pseudocodeCache.length}</div>
        <div class="text-xs text-gray-400 mt-1">å·²å¯ç”¨ / æ€»æ•°</div>
      </div>
    </div>`;

  const sections = [summary];

  if(commandsCache.length){
    const cmdList = commandsCache.slice(0,5).map(cmd => {
      const pseudo = commandPseudo(cmd);
      const codeData = {
        command: cmd.command,
        kind: cmd.kind,
        reply: cmd.reply,
        parse_mode: cmd.parse_mode,
        disable_preview: cmd.disable_preview,
        payload: cmd.payload,
      };
      return `
        <details class="rounded-lg border border-gray-200 bg-white/70 p-3">
          <summary class="flex items-center justify-between text-sm font-medium text-gray-700 cursor-pointer select-none">
            <span>${escapeHtml(cmd.command)}</span>
            <span class="flex items-center gap-2 text-xs text-gray-400">
              <span>${escapeHtml(cmd.kind || 'text')}</span>
              <span class="px-2 py-0.5 rounded-full ${cmd.active ? 'bg-emerald-100 text-emerald-600' : 'bg-gray-100 text-gray-500'}">${cmd.active ? 'å¯ç”¨' : 'åœç”¨'}</span>
            </span>
          </summary>
          <div class="grid md:grid-cols-2 gap-3 mt-2 text-xs">
            <div>
              <div class="text-gray-400 mb-1">ä¼ªä»£ç </div>
              <pre class="bg-amber-50 text-amber-900 rounded-lg p-3 whitespace-pre-wrap">${escapeHtml(pseudo)}</pre>
            </div>
            <div>
              <div class="text-gray-400 mb-1">JSON</div>
              <pre class="bg-slate-900 text-emerald-300 rounded-lg p-3 overflow-auto max-h-44">${escapeHtml(prettyJson(codeData))}</pre>
            </div>
          </div>
        </details>`;
    }).join('');
    sections.push(`
      <section class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-600">å›ºå®šæŒ‡ä»¤æ¦‚è§ˆ</h3>
        ${cmdList}
        ${commandsCache.length>5 ? '<p class="text-xs text-gray-400">ä»…å±•ç¤ºå‰ 5 æ¡ï¼Œå…¶ä½™è¯·åœ¨ä¸Šæ–¹é¢æ¿æŸ¥çœ‹ã€‚</p>' : ''}
      </section>`);
  }

  if(flowsCache.length){
    const flowList = flowsCache.slice(0,5).map(flow => {
      const pseudo = flowPseudo(flow.compiled || {});
      return `
        <details class="rounded-lg border border-gray-200 bg-white/70 p-3">
          <summary class="flex items-center justify-between text-sm font-medium text-gray-700 cursor-pointer select-none">
            <span>${escapeHtml(flow.name)}</span>
            <span class="px-2 py-0.5 rounded-full text-xs ${flow.active ? 'bg-emerald-100 text-emerald-600' : 'bg-gray-100 text-gray-500'}">${flow.active ? 'å¯ç”¨' : 'åœç”¨'}</span>
          </summary>
          <div class="grid md:grid-cols-2 gap-3 mt-2 text-xs">
            <div>
              <div class="text-gray-400 mb-1">ä¼ªä»£ç </div>
              <pre class="bg-amber-50 text-amber-900 rounded-lg p-3 whitespace-pre-wrap">${escapeHtml(pseudo)}</pre>
            </div>
            <div>
              <div class="text-gray-400 mb-1">èŠ‚ç‚¹ JSON</div>
              <pre class="bg-slate-900 text-sky-200 rounded-lg p-3 overflow-auto max-h-44">${escapeHtml(prettyJson(flow.compiled || {}))}</pre>
            </div>
          </div>
        </details>`;
    }).join('');
    sections.push(`
      <section class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-600">æµç¨‹ç¼–æ’æ¦‚è§ˆ</h3>
        ${flowList}
        ${flowsCache.length>5 ? '<p class="text-xs text-gray-400">ä»…å±•ç¤ºå‰ 5 æ¡ï¼Œå…¶ä½™è¯·åœ¨ä¸Šæ–¹é¢æ¿æŸ¥çœ‹ã€‚</p>' : ''}
      </section>`);
  }

  if(pseudocodeCache.length){
    const pseudoList = pseudocodeCache.slice(0,5).map(item => {
      const preview = (item.content || '').split('\n').slice(0,6).join('\n');
      return `
        <details class="rounded-lg border border-gray-200 bg-white/70 p-3">
          <summary class="flex items-center justify-between text-sm font-medium text-gray-700 cursor-pointer select-none">
            <span>${escapeHtml(item.title || 'æœªå‘½åä¼ªä»£ç ')}</span>
            <span class="flex items-center gap-2 text-xs text-gray-400">
              <span>ID ${item.id}</span>
              <span class="px-2 py-0.5 rounded-full ${item.active ? 'bg-emerald-100 text-emerald-600' : 'bg-gray-100 text-gray-500'}">${item.active ? 'å¯ç”¨' : 'åœç”¨'}</span>
            </span>
          </summary>
          <div class="mt-2 text-xs text-gray-600 whitespace-pre-wrap bg-amber-50 text-amber-900 rounded-lg p-3">${escapeHtml(preview)}</div>
        </details>`;
    }).join('');
    sections.push(`
      <section class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-600">ä¸­æ–‡ä¼ªä»£ç æ¦‚è§ˆ</h3>
        ${pseudoList}
        ${pseudocodeCache.length>5 ? '<p class="text-xs text-gray-400">ä»…å±•ç¤ºå‰ 5 æ¡ï¼Œå…¶ä½™è¯·åœ¨ä¸Šæ–¹é¢æ¿æŸ¥çœ‹ã€‚</p>' : ''}
      </section>`);
  }

  wrap.innerHTML = sections.join('');
}

async function refreshOverview(){
  if(!currentBotId){
    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Bot');
    return;
  }
  await Promise.all([loadCmds(), loadFlows(), loadPseudocode()]);
}



function highlightSelectedBot(id){
  const cards = document.querySelectorAll('.bot-card');
  cards.forEach(card => {
    if(id != null && Number(card.dataset.botId) === Number(id)){
      card.classList.add('ring','ring-indigo-400','shadow-2xl');
    }else{
      card.classList.remove('ring','ring-indigo-400','shadow-2xl');
    }
  });
}

async function addBot(){
  const name=document.getElementById('new_bot_name').value.trim();
  const token=document.getElementById('new_bot_token').value.trim();
  if(!name||!token){alert('name/token å¿…å¡«');return;}
  const r=await fetch('/api/bots',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin',body:JSON.stringify({name,token})});
  const j=await r.json(); if(!j.ok){alert(j.error||'å¤±è´¥');return;}
  document.getElementById('new_bot_name').value=''; document.getElementById('new_bot_token').value='';
  loadBots();
}

async function delBot(id){
  if(!confirm('ç¡®è®¤åˆ é™¤è¯¥ botï¼Ÿ')) return;
  const r=await fetch('/api/bots/'+id,{method:'DELETE',credentials:'same-origin'}); const j=await r.json();
  if(!j.ok) alert(j.error||'å¤±è´¥');
  currentBotId=null;
  document.getElementById('current_bot').innerText='';
  document.getElementById('cmd_cards').innerHTML='';
  document.getElementById('flow_cards').innerHTML='';
  loadBots();
}

/* --------- é€‰ä¸­ botï¼šåŠ è½½æ•°æ® + å¯åŠ¨è½®è¯¢ --------- */
function selectBot(id, name){
  currentBotId=id;
  document.getElementById('current_bot').innerText=`ï¼ˆå½“å‰ï¼š${name} #${id}ï¼‰`;
  highlightSelectedBot(id);
  resetGroupForm('commands');
  resetGroupForm('flows');
  resetGroupForm('pro_scripts');
  resetGroupForm('pseudocode');
  loadAllGroups();
  loadCmds();
  loadFlows();
  loadProScripts(); // æ–°å¢
  resetPseudoForm();
  loadPseudocode();
  refreshStatus();
  if(_logTimer) clearInterval(_logTimer);
  _logTimer = setInterval(refreshStatus, 5000);
}
window.addEventListener('beforeunload', ()=>{
  if(_logTimer) clearInterval(_logTimer);
  disconnectStatusSocket();
});

/* ---------- æŒ‡ä»¤ ---------- */
function resetProForm(){
  document.getElementById('pro_id').value = '';
  document.getElementById('pro_name').value = '';
  document.getElementById('pro_command').value = '';
  document.getElementById('pro_code').value = '';
  const proGroup = document.getElementById('pro_group');
  if(proGroup) proGroup.value = '';
  document.getElementById('pro_active').checked = true;
  document.getElementById('pro_status').innerText = '';
}

async function loadProScripts() {
    if(!currentBotId) return;
    const r = await fetch(`/api/bots/${currentBotId}/pro_scripts`, { credentials: 'same-origin' });
    const j = await r.json();
    const tb = document.getElementById('pro_scripts_table');
    tb.innerHTML = '';
    proScriptsCache = (j.items || []).map(it => {
        const active = isActiveFlag(it.active);
        const groupActive = Number(it.group_active ?? 1) === 1;
        return {
            ...it,
            active,
            group_active: it.group_active,
            effective_active: active && groupActive,
        };
    });

    proScriptsCache.forEach(it => {
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const excerpt = (it.code || '').split('\n')[0].slice(0, 50) + '...';
        const gid = normalizeGroupId(it.group_id);
        const groupSelect = `<select class="border rounded-md px-2 py-1 text-xs" onchange="setProScriptGroup(${it.id}, normalizeGroupId(this.value));">
            ${renderGroupOptions('pro_scripts', gid)}
        </select>`;
        const groupActive = Number(it.group_active ?? 1) === 1;
        const isActive = !!it.active;
        const stateText = !isActive ? 'åœç”¨' : (groupActive ? 'å¯ç”¨' : 'ç»„åœç”¨');
        const stateClass = !isActive
          ? 'bg-gray-100 text-gray-500'
          : (groupActive ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-700');
        tr.innerHTML = `<td class="py-2">${escapeHtml(it.name)}</td>
            <td><code>${escapeHtml(it.command)}</code></td>
            <td>${groupSelect}</td>
            <td class="text-gray-500"><code>${escapeHtml(excerpt)}</code></td>
            <td><span class="text-xs px-2 py-0.5 rounded-full ${stateClass}">${stateText}</span></td>
            <td class="space-x-2">
                <button class="text-sm ${isActive ? 'text-amber-600 hover:text-amber-700' : 'text-emerald-600 hover:text-emerald-700'}" onclick="setProScriptActive(${it.id}, ${isActive ? 'false' : 'true'})">${isActive ? 'åœç”¨' : 'å¯ç”¨'}</button>
                <button class="text-sm text-indigo-600" onclick="editProScript(${it.id})">ç¼–è¾‘</button>
                <button class="text-sm text-red-600" onclick="deleteProScript(${it.id})">åˆ é™¤</button>
            </td>`;
        tb.appendChild(tr);
    });
}

function editProScript(id) {
    const script = proScriptsCache.find(s => s.id === id);
    if (!script) return;
    document.getElementById('pro_id').value = script.id;
    document.getElementById('pro_name').value = script.name;
    document.getElementById('pro_command').value = script.command;
    document.getElementById('pro_code').value = script.code;
    const groupSelect = document.getElementById('pro_group');
    if(groupSelect){
        const gid = normalizeGroupId(script.group_id);
        groupSelect.innerHTML = renderGroupOptions('pro_scripts', gid);
        groupSelect.value = gid ?? '';
    }
    document.getElementById('pro_active').checked = !!script.active;
    document.getElementById('pro_status').innerText = `âœï¸ ç¼–è¾‘è„šæœ¬: ${script.name}`;
    setActivePanel('pro');
}

async function saveProScript() {
    if (!currentBotId) { alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª Bot'); return; }
    const id = document.getElementById('pro_id').value || undefined;
    const payload = {
        name: document.getElementById('pro_name').value,
        command: document.getElementById('pro_command').value,
        code: document.getElementById('pro_code').value,
        active: document.getElementById('pro_active').checked,
        group_id: normalizeGroupId(document.getElementById('pro_group').value),
    };
    if (id) payload.id = Number(id);

    const r = await fetch(`/api/bots/${currentBotId}/pro_scripts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
    });
    const j = await r.json();
    const statusEl = document.getElementById('pro_status');
    statusEl.innerText = j.ok ? 'âœ… è„šæœ¬å·²ä¿å­˜ã€‚é‡å¯/é‡è½½ Bot åç”Ÿæ•ˆã€‚' : `âŒ ä¿å­˜å¤±è´¥: ${j.error || 'æœªçŸ¥é”™è¯¯'}`;
    if (j.ok) {
        resetProForm();
        loadProScripts();
    }
}

async function deleteProScript(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè„šæœ¬å—ï¼Ÿ')) return;
    const r = await fetch(`/api/bots/${currentBotId}/pro_scripts/${id}`, {
        method: 'DELETE',
        credentials: 'same-origin',
    });
    const j = await r.json();
    const statusEl = document.getElementById('pro_status');
    statusEl.innerText = j.ok ? 'ğŸ—‘ï¸ è„šæœ¬å·²åˆ é™¤ã€‚' : `âŒ åˆ é™¤å¤±è´¥: ${j.error || 'æœªçŸ¥é”™è¯¯'}`;
    loadProScripts();
}

async function setProScriptActive(id, active){
    if(!currentBotId) return;
    const r = await fetch(`/api/bots/${currentBotId}/pro_scripts/${id}/active`, {
        method:'PATCH',
        credentials:'same-origin',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ active: !!active }),
    });
    const j = await r.json();
    const statusEl = document.getElementById('pro_status');
    statusEl.innerText = j.ok ? (active ? 'âœ… è„šæœ¬å·²å¯ç”¨' : 'â¸ï¸ è„šæœ¬å·²åœç”¨') : `âŒ æ“ä½œå¤±è´¥: ${j.error || 'æœªçŸ¥é”™è¯¯'}`;
    if(j.ok){ loadProScripts(); refreshStatus(); }
}

async function setProScriptGroup(id, groupId){
    if(!currentBotId) return;
    const r = await fetch(`/api/bots/${currentBotId}/pro_scripts/${id}/group`, {
        method:'PATCH',
        credentials:'same-origin',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ group_id: groupId })
    });
    const j = await r.json();
    const statusEl = document.getElementById('pro_status');
    statusEl.innerText = j.ok ? 'ğŸ”— åˆ†ç»„å·²æ›´æ–°' : `âŒ æ“ä½œå¤±è´¥: ${j.error || 'æœªçŸ¥é”™è¯¯'}`;
    if(j.ok){ loadProScripts(); }
}
async function loadCmds(){
  if(!currentBotId) return;
  const r = await fetch(`/api/bots/${currentBotId}/commands`, { credentials:'same-origin' });
  const j = await r.json();
  const wrap = document.getElementById('cmd_cards');
  wrap.innerHTML = '';
  const rawItems = j.items || [];
  const items = rawItems.map(it => {
    const active = isActiveFlag(it.active);
    const groupActive = Number(it.group_active ?? 1) === 1;
    return {
      ...it,
      active,
      group_active: it.group_active,
      effective_active: active && groupActive,
    };
  });
  commandsCache = items;
  if(!items.length){
    wrap.innerHTML = '<div class="text-sm text-gray-500">æš‚æ— å›ºå®šæŒ‡ä»¤ï¼Œå…ˆåœ¨ä¸Šæ–¹æ·»åŠ ä¸€ä¸ªå§ï½</div>';
    updateOverview();
    return;
  }
  items.forEach((it, idx)=>{
    const payloadParsed = parseMaybeJson(it.payload) || {};
    const card = document.createElement('div');
    const domId = `${it.id||idx}`;
    const isActive = !!it.active;
    const groupActive = Number(it.group_active ?? 1) === 1;
    const effectiveActive = isActive && groupActive;
    const stateText = !isActive ? 'åœç”¨' : (groupActive ? 'å¯ç”¨' : 'ç»„åœç”¨');
    const stateClass = !isActive
      ? 'bg-gray-100 text-gray-500'
      : (groupActive ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-700');
    const commandId = Number.isFinite(Number(it.id)) ? Number(it.id) : null;
    const pseudo = commandPseudo({...it, payload: payloadParsed});
    const codeJson = prettyJson({
      command: it.command,
      kind: it.kind,
      reply: it.reply,
      parse_mode: it.parse_mode,
      disable_preview: it.disable_preview,
      payload: payloadParsed,
    });
    const stateBadge = `<span class="text-xs px-2 py-0.5 rounded-full ${stateClass}">${stateText}</span>`;
    const toggleBtn = commandId === null ? '' : `<button class="text-xs text-${isActive ? 'amber' : 'emerald'}-600 hover:text-${isActive ? 'amber' : 'emerald'}-700" onclick="setCommandActive(${commandId}, ${isActive ? 'false' : 'true'}); event.stopPropagation();">${isActive ? 'åœç”¨' : 'å¯ç”¨'}</button>`;
    const groupBadge = it.group_name
      ? `<span class="text-xs px-2 py-0.5 rounded-full ${groupActive ? 'bg-sky-100 text-sky-600' : 'bg-orange-100 text-orange-600'}">${escapeHtml(it.group_name)}${groupActive ? '' : 'ï¼ˆç»„åœç”¨ï¼‰'}</span>`
      : `<span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">æœªåˆ†ç»„</span>`;
    const groupSelect = commandId === null ? '' : `
      <label class="flex items-center gap-2 text-xs text-gray-500">
        <span>åˆ†ç»„</span>
        <select class="border rounded-md px-2 py-1 text-sm" onchange="setCommandGroup(${commandId}, normalizeGroupId(this.value)); event.stopPropagation();">
          ${renderGroupOptions('commands', it.group_id)}
        </select>
      </label>`;
    card.className='animate-card rounded-2xl border border-gray-100 bg-white shadow transition-all duration-300 hover:-translate-y-0.5 hover:shadow-xl';
    card.innerHTML = `
      <div class="p-4 flex flex-col gap-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-800 flex items-center gap-2">
              ${escapeHtml(it.command)}
              <span class="text-xs px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-600">${escapeHtml(it.kind||'text')}</span>
              ${stateBadge}
            </h3>
            <p class="text-xs text-gray-400 mt-1">ParseMode: ${it.parse_mode || 'None'} ï½œ é¢„è§ˆï¼š${it.disable_preview? 'å…³é—­':'å¼€å¯'}</p>
            <div class="flex items-center gap-2 mt-2 text-xs">
              ${groupBadge}
              ${groupSelect}
            </div>
          </div>
          <div class="flex flex-col items-end gap-1 text-xs text-gray-400">
            ${toggleBtn}
            <button class="text-red-500 hover:text-red-600" onclick="delCmd('${it.command.replaceAll("'","\\'")}'); event.stopPropagation();">åˆ é™¤</button>
          </div>
        </div>
        <div class="text-sm text-gray-600">
          ${(it.reply || payloadParsed.text || '').slice(0,80) || 'ï¼ˆæ— é»˜è®¤æ–‡æœ¬ï¼‰'}
        </div>
        <div class="flex flex-wrap gap-2 text-xs">
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" onclick="toggleDetails('cmd-code-${domId}')">æŸ¥çœ‹ä»£ç </button>
          <button class="px-3 py-1.5 rounded-md bg-amber-100 hover:bg-amber-200" onclick="toggleDetails('cmd-pseudo-${domId}')">æŸ¥çœ‹ä¼ªä»£ç </button>
        </div>
        <pre id="cmd-code-${domId}" class="hidden bg-gray-900 text-emerald-200 rounded-lg p-3 text-xs overflow-auto max-h-48">${escapeHtml(codeJson)}</pre>
        <pre id="cmd-pseudo-${domId}" class="hidden bg-amber-50 text-amber-900 rounded-lg p-3 text-xs leading-5 whitespace-pre-wrap">${escapeHtml(pseudo)}</pre>
      </div>`;
    wrap.appendChild(card);
  });
  updateOverview();
}

async function saveCmd(){
  if(!currentBotId){ alert('å…ˆé€‰æ‹©ä¸€ä¸ª bot'); return; }
  const command = document.getElementById('cmd').value.trim();
  const kind = document.getElementById('kind').value;
  const reply = document.getElementById('reply').value.trim();
  const parse_mode = document.getElementById('parse_mode').value || null;
  const disable_preview = document.getElementById('no_preview').checked;
  const media_url = document.getElementById('media_url').value.trim();

  let payload = null;
  if(kind === 'text'){
    payload = { text: reply || '' };
  } else {
    payload = { url: media_url || '', caption: reply || '' };
  }
  const group_id = normalizeGroupId(document.getElementById('cmd_group').value);

  const r = await fetch(`/api/bots/${currentBotId}/commands`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify({ command, kind, reply, payload, parse_mode, disable_preview, active: true, group_id })
  });
  const j = await r.json();
  document.getElementById('status').innerText = j.ok ? 'âœ… å·²ä¿å­˜' : ('âŒ '+(j.error||'å¤±è´¥'));
  loadCmds();
}

async function delCmd(command){
  const r=await fetch(`/api/bots/${currentBotId}/commands/`+encodeURIComponent(command.replace(/^\//,'')),{method:'DELETE',credentials:'same-origin'});
  const j=await r.json(); document.getElementById('status').innerText=j.ok?'ğŸ—‘ï¸ å·²åˆ ':'âŒ å¤±è´¥'; loadCmds();
}

async function setCommandActive(id, active){
  if(!currentBotId || id==null){ return; }
  const r = await fetch(`/api/bots/${currentBotId}/commands/${id}/active`, {
    method:'PATCH',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ active: !!active })
  });
  const j = await r.json();
  const statusEl = document.getElementById('status');
  statusEl.innerText = j.ok ? (active ? 'âœ… æŒ‡ä»¤å·²å¯ç”¨' : 'â¸ï¸ æŒ‡ä»¤å·²åœç”¨') : ('âŒ '+(j.error||'çŠ¶æ€æ›´æ–°å¤±è´¥'));
  if(j.ok){ loadCmds(); loadBots(); }
}

async function setCommandGroup(id, groupId){
  if(!currentBotId || id==null) return;
  const r = await fetch(`/api/bots/${currentBotId}/commands/${id}/group`, {
    method:'PATCH',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ group_id: groupId })
  });
  const j = await r.json();
  const statusEl = document.getElementById('status');
  statusEl.innerText = j.ok ? 'ğŸ”— åˆ†ç»„å·²æ›´æ–°' : ('âŒ '+(j.error||'åˆ†ç»„æ›´æ–°å¤±è´¥'));
  if(j.ok){ loadCmds(); }
}

async function eraseAll(){
  if(!confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å‘½ä»¤ï¼Ÿ')) return;
  const r=await fetch(`/api/bots/${currentBotId}/commands`,{method:'DELETE',credentials:'same-origin'}); const j=await r.json();
  document.getElementById('status').innerText=j.ok?'ğŸ§¹ å·²æ¸…ç©º':'âŒ å¤±è´¥'; loadCmds();
}

async function aiGenerateCommand(){
  if(!currentBotId){ alert('å…ˆé€‰æ‹©ä¸€ä¸ª bot'); return; }
  const prompt = document.getElementById('cmd_ai_prompt').value.trim();
  const r = await fetch('/api/ai/generate', {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode:'command', prompt })
  });
  const j = await r.json();
  if(!j.ok){
    document.getElementById('status').innerText = 'âŒ '+(j.error||'AI ç”ŸæˆæŒ‡ä»¤å¤±è´¥');
    return;
  }
  const result = j.result || {};
  document.getElementById('cmd').value = result.command || '/auto';
  document.getElementById('kind').value = result.kind || 'text';
  document.getElementById('reply').value = result.reply || '';
  document.getElementById('parse_mode').value = result.parse_mode || '';
  document.getElementById('no_preview').checked = !!result.disable_preview;
  const meta = j.meta || {};
  let note = 'ğŸ¤– å·²æ ¹æ®æç¤ºç”ŸæˆæŒ‡ä»¤è‰ç¨¿ï¼Œç¡®è®¤åç‚¹å‡»ä¿å­˜ã€‚';
  if(meta.api_key_configured === false){
    note += 'ï¼ˆå½“å‰ä½¿ç”¨ç¦»çº¿æ¨¡æ¿ï¼Œå¦‚éœ€çœŸå® AIï¼Œè¯·é…ç½® AI_API_KEYã€‚ï¼‰';
  }
  document.getElementById('status').innerText = note;
  setActivePanel('commands');
}

/* ---------- è¿è¡Œæ§åˆ¶ ---------- */
async function startBot(){
  const r=await fetch(`/api/bots/${currentBotId}/start`,{method:'POST',credentials:'same-origin'}); const j=await r.json();
  document.getElementById('status').innerText=j.ok?('ğŸš€ '+j.msg):('âŒ '+(j.error||j.msg));
  // refreshStatus() å’Œ loadBots() å·²è¢«åˆ é™¤
}
async function stopBot(){
  const r=await fetch(`/api/bots/${currentBotId}/stop`,{method:'POST',credentials:'same-origin'}); const j=await r.json();
  document.getElementById('status').innerText=j.ok?('ğŸ›‘ '+j.msg):('âŒ '+(j.error||j.msg));
}
async function syncMenu(){
  const r=await fetch(`/api/bots/${currentBotId}/sync`,{method:'POST',credentials:'same-origin'}); const j=await r.json();
  document.getElementById('status').innerText=j.ok?('ğŸ”„ '+j.msg):('âŒ '+(j.error||j.msg));
}

/* ---------- Flow ç›¸å…³ ---------- */
function openBlocks(flowId){
  if(!currentBotId){ alert('å…ˆé€‰æ‹©ä¸€ä¸ª bot'); return; }
  window.open(`/static/blocks.html?bot_id=${currentBotId}` + (flowId?`&flow_id=${flowId}`:''), '_blank');
}

async function loadFlows(){
  if(!currentBotId) return;
  const r = await fetch(`/api/bots/${currentBotId}/flows`, { credentials:'same-origin' });
  const j = await r.json();
  const wrap = document.getElementById('flow_cards');
  wrap.innerHTML = '';
  const rawItems = j.items || [];
  const items = rawItems.map(f => {
    const active = isActiveFlag(f.active);
    const groupActive = Number(f.group_active ?? 1) === 1;
    return {
      ...f,
      active,
      group_active: f.group_active,
      effective_active: active && groupActive,
      compiled: f.blocks_compiled || parseFlowCompiled(f.blocks_json),
    };
  });
  flowsCache = items;
  if(!items.length){
    wrap.innerHTML = '<div class="text-sm text-gray-500">æš‚æ— æµç¨‹ï¼Œç‚¹å‡»å³ä¸Šè§’ã€Œæ–°å»º/ç¼–è¾‘ã€å¼€å§‹åˆ›å»ºã€‚</div>';
    updateOverview();
    return;
  }
  items.forEach((f, idx)=>{
    const pseudo = flowPseudo(f.compiled);
    const codeJson = f.compiled ? prettyJson(f.compiled) : prettyJson(f.blocks_json || {});
    const card = document.createElement('div');
    card.className = 'animate-card rounded-2xl border border-gray-100 bg-white shadow transition-all duration-300 hover:-translate-y-0.5 hover:shadow-xl';
    const domId = `${f.id||idx}`;
    const isActive = !!f.active;
    const groupActive = Number(f.group_active ?? 1) === 1;
    const effectiveActive = isActive && groupActive;
    const stateText = !isActive ? 'åœç”¨' : (groupActive ? 'å¯ç”¨' : 'ç»„åœç”¨');
    const stateClass = !isActive
      ? 'bg-gray-100 text-gray-500'
      : (groupActive ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-700');
    const flowId = Number.isFinite(Number(f.id)) ? Number(f.id) : null;
    const toggleBtn = flowId === null ? '' : `<button class="text-${isActive ? 'amber' : 'emerald'}-600 hover:text-${isActive ? 'amber' : 'emerald'}-700" onclick="setFlowActive(${flowId}, ${isActive ? 'false' : 'true'}); event.stopPropagation();">${isActive ? 'åœç”¨' : 'å¯ç”¨'}</button>`;
    const groupBadge = f.group_name
      ? `<span class="text-xs px-2 py-0.5 rounded-full ${groupActive ? 'bg-sky-100 text-sky-600' : 'bg-orange-100 text-orange-600'}">${escapeHtml(f.group_name)}${groupActive ? '' : 'ï¼ˆç»„åœç”¨ï¼‰'}</span>`
      : `<span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">æœªåˆ†ç»„</span>`;
    const groupSelect = flowId === null ? '' : `
      <label class="flex items-center gap-2 text-xs text-gray-500">
        <span>åˆ†ç»„</span>
        <select class="border rounded-md px-2 py-1 text-sm" onchange="setFlowGroup(${flowId}, normalizeGroupId(this.value)); event.stopPropagation();">
          ${renderGroupOptions('flows', f.group_id)}
        </select>
      </label>`;
    card.innerHTML = `
      <div class="p-4 flex flex-col gap-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-800 flex items-center gap-2">
              ${escapeHtml(f.name)}
              <span class="text-xs px-2 py-0.5 rounded-full ${stateClass}">${stateText}</span>
            </h3>
            <p class="text-xs text-gray-400 mt-1">æ›´æ–°ï¼š${fmt.date(f.updated_at || f.created_at)}</p>
            <div class="flex items-center gap-2 mt-2 text-xs">
              ${groupBadge}
              ${groupSelect}
            </div>
          </div>
          <div class="flex flex-col gap-1 text-xs text-right text-gray-400">
            ${toggleBtn}
            <button class="text-indigo-600 hover:text-indigo-700" onclick="openBlocks(${f.id}); event.stopPropagation();">ç¼–è¾‘</button>
            <button class="text-red-500 hover:text-red-600" onclick="deleteFlow(${f.id}); event.stopPropagation();">åˆ é™¤</button>
          </div>
        </div>
        <div class="text-sm text-gray-600 whitespace-pre-wrap max-h-24 overflow-hidden">
          ${escapeHtml(pseudo.split('\n').slice(0,4).join('\n'))}${pseudo.split('\n').length>4?'\n...':''}
        </div>
        <div class="flex flex-wrap gap-2 text-xs">
          <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200" onclick="toggleDetails('flow-code-${domId}')">æŸ¥çœ‹ä»£ç </button>
          <button class="px-3 py-1.5 rounded-md bg-amber-100 hover:bg-amber-200" onclick="toggleDetails('flow-pseudo-${domId}')">æŸ¥çœ‹ä¼ªä»£ç </button>
        </div>
        <pre id="flow-code-${domId}" class="hidden bg-gray-900 text-sky-200 rounded-lg p-3 text-xs overflow-auto max-h-56">${escapeHtml(codeJson)}</pre>
        <pre id="flow-pseudo-${domId}" class="hidden bg-amber-50 text-amber-900 rounded-lg p-3 text-xs leading-5 whitespace-pre-wrap">${escapeHtml(pseudo)}</pre>
      </div>`;
    wrap.appendChild(card);
  });
  updateOverview();
}


async function setFlowActive(flowId, active){
  if(!currentBotId || flowId==null) return;
  const r = await fetch(`/api/bots/${currentBotId}/flows/${flowId}/active`, {
    method:'PATCH',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ active: !!active })
  });
  const j = await r.json();
  const statusEl = document.getElementById('status');
  statusEl.innerText = j.ok ? (active ? 'âœ… æµç¨‹å·²å¯ç”¨' : 'â¸ï¸ æµç¨‹å·²åœç”¨') : ('âŒ '+(j.error||'æµç¨‹çŠ¶æ€æ›´æ–°å¤±è´¥'));
  if(j.ok){ loadFlows(); refreshStatus(); }
}


async function deleteFlow(flowId){
  if(!confirm('ç¡®è®¤åˆ é™¤è¯¥æµç¨‹ï¼Ÿ')) return;
  const r = await fetch(`/api/bots/${currentBotId}/flows/${flowId}`, { method:'DELETE', credentials:'same-origin' });
  const j = await r.json();
  document.getElementById('status').innerText = j.ok ? 'ğŸ—‘ï¸ å·²åˆ é™¤æµç¨‹' : 'âŒ åˆ é™¤å¤±è´¥';
  loadFlows();
}

async function publishFlows(){
  const r = await fetch(`/api/bots/${currentBotId}/start`, { method:'POST', credentials:'same-origin' });
  const j = await r.json();
  document.getElementById('status').innerText = j.ok ? 'ğŸš€ å·²å‘å¸ƒï¼ˆé‡è½½ï¼‰' : ('âŒ '+(j.error||j.msg));
  refreshStatus();
  loadBots();
}

/* ---------- ä¼ªä»£ç ï¼ˆä¸­æ–‡ï¼‰ ---------- */
function resetPseudoForm(){
  document.getElementById('pseudo_id').value='';
  document.getElementById('pseudo_title').value='';
  document.getElementById('pseudo_content').value='';
  const pseudoGroup = document.getElementById('pseudo_group');
  if(pseudoGroup) pseudoGroup.value='';
  document.getElementById('pseudo_status').innerText='';
}

async function loadPseudocode(){
  if(!currentBotId) return;
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode`, { credentials:'same-origin' });
  const j = await r.json();
  const tb = document.getElementById('pseudocode_table');
  tb.innerHTML='';
  pseudoCache = {};
  const sandboxBox = document.getElementById('sandbox_output');
  if(sandboxBox){ sandboxBox.classList.add('hidden'); sandboxBox.textContent=''; }
  const items = (j.items||[]).map(it => {
    const active = isActiveFlag(it.active);
    const groupActive = Number(it.group_active ?? 1) === 1;
    return {
      ...it,
      active,
      group_active: it.group_active,
      effective_active: active && groupActive,
    };
  });
  pseudocodeCache = items;
  items.forEach(it=>{
    pseudoCache[it.id] = it;
    const tr = document.createElement('tr'); tr.className='border-t';
    // ä¿®å¤ï¼šå°†éæ³•çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸º \n
    const excerpt = (it.content||'').split('\n').slice(0,2).join(' / ');
    const groupActive = Number(it.group_active ?? 1) === 1;
    const isActive = !!it.active;
    const stateText = !isActive ? 'åœç”¨' : (groupActive ? 'å¯ç”¨' : 'ç»„åœç”¨');
    const stateClass = !isActive
      ? 'bg-gray-100 text-gray-500'
      : (groupActive ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-700');
    const stateBadge = `<span class="text-xs px-2 py-0.5 rounded-full ${stateClass}">${stateText}</span>`;
    const toggleBtn = `<button class="text-sm ${isActive ? 'text-amber-600 hover:text-amber-700' : 'text-emerald-600 hover:text-emerald-700'}" onclick="setPseudocodeActive(${it.id}, ${isActive ? 'false' : 'true'}); event.stopPropagation();">${isActive ? 'åœç”¨' : 'å¯ç”¨'}</button>`;
    const gid = normalizeGroupId(it.group_id);
    const groupSelect = `<select class="border rounded-md px-2 py-1 text-xs" onchange="setPseudocodeGroup(${it.id}, normalizeGroupId(this.value));">
      ${renderGroupOptions('pseudocode', gid)}
    </select>`;
    tr.innerHTML = `<td class="py-2">${it.id}</td>
      <td>${escapeHtml(it.title)}</td>
      <td class="text-gray-500">${escapeHtml(excerpt)}</td>
      <td>${groupSelect}</td>
      <td>${stateBadge}</td>
      <td class="space-x-2">
        ${toggleBtn}
        <button class="text-indigo-600" onclick="editPseudocode(${it.id}); event.stopPropagation();">ç¼–è¾‘</button>
        <button class="text-emerald-600" onclick="generateFlowFromPseudo(${it.id}); event.stopPropagation();">ç”Ÿæˆæµç¨‹</button>
        <button class="text-amber-600" onclick="sandboxPseudo(${it.id}); event.stopPropagation();">æ²™ç›’</button>
        <button class="text-red-600" onclick="deletePseudocode(${it.id}); event.stopPropagation();">åˆ é™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  updateOverview();
}


function editPseudocode(id){
  const data = pseudoCache && pseudoCache[id];
  if(!data) return;
  document.getElementById('pseudo_id').value = data.id;
  document.getElementById('pseudo_title').value = data.title || '';
  document.getElementById('pseudo_content').value = data.content || '';
  const pseudoGroup = document.getElementById('pseudo_group');
  if(pseudoGroup){
    const gid = normalizeGroupId(data.group_id);
    pseudoGroup.innerHTML = renderGroupOptions('pseudocode', gid);
    pseudoGroup.value = gid ?? '';
  }
  document.getElementById('pseudo_status').innerText = 'âœï¸ å½“å‰ç¼–è¾‘ï¼š' + data.title;
}

async function savePseudocode(){
  if(!currentBotId){ alert('å…ˆé€‰æ‹©ä¸€ä¸ª bot'); return; }
  const id = document.getElementById('pseudo_id').value || undefined;
  const title = document.getElementById('pseudo_title').value.trim();
  const content = document.getElementById('pseudo_content').value.trim();
  if(!title || !content){
    document.getElementById('pseudo_status').innerText = 'âŒ è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹ï¼ˆä¸­æ–‡ä¼ªä»£ç ï¼‰ã€‚';
    return;
  }
  const payload = { title, content };
  payload.group_id = normalizeGroupId(document.getElementById('pseudo_group').value);
  payload.active = true;
  if(id) payload.id = Number(id);
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify(payload),
  });
  const j = await r.json();
  document.getElementById('pseudo_status').innerText = j.ok ? 'âœ… ä¼ªä»£ç å·²ä¿å­˜' : ('âŒ '+(j.error||'ä¿å­˜å¤±è´¥'));
  if(j.ok){
    resetPseudoForm();
    loadPseudocode();
  }
}

async function deletePseudocode(id){
  if(!confirm('ç¡®å®šåˆ é™¤è¯¥ä¼ªä»£ç ï¼Ÿ')) return;
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode/${id}`, { method:'DELETE', credentials:'same-origin' });
  const j = await r.json();
  document.getElementById('pseudo_status').innerText = j.ok ? 'ğŸ—‘ï¸ å·²åˆ é™¤ä¼ªä»£ç ' : ('âŒ '+(j.error||'åˆ é™¤å¤±è´¥'));
  loadPseudocode();
}

async function setPseudocodeActive(id, active){
  if(!currentBotId) return;
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode/${id}/active`, {
    method:'PATCH',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ active: !!active })
  });
  const j = await r.json();
  const statusEl = document.getElementById('pseudo_status');
  statusEl.innerText = j.ok ? (active ? 'âœ… ä¼ªä»£ç å·²å¯ç”¨' : 'â¸ï¸ ä¼ªä»£ç å·²åœç”¨') : ('âŒ '+(j.error||'çŠ¶æ€æ›´æ–°å¤±è´¥'));
  if(j.ok){ loadPseudocode(); }
}

async function setPseudocodeGroup(id, groupId){
  if(!currentBotId) return;
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode/${id}/group`, {
    method:'PATCH',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ group_id: groupId })
  });
  const j = await r.json();
  const statusEl = document.getElementById('pseudo_status');
  statusEl.innerText = j.ok ? 'ğŸ”— åˆ†ç»„å·²æ›´æ–°' : ('âŒ '+(j.error||'çŠ¶æ€æ›´æ–°å¤±è´¥'));
  if(j.ok){ loadPseudocode(); }
}

async function generateFlowFromPseudo(id){
  if(!currentBotId){ alert('å…ˆé€‰æ‹©ä¸€ä¸ª bot'); return; }
  const targetId = id || document.getElementById('pseudo_id').value;
  if(!targetId){
    document.getElementById('pseudo_status').innerText = 'âŒ è¯·å…ˆé€‰æ‹©æˆ–ä¿å­˜ä¼ªä»£ç ã€‚';
    return;
  }
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode/${targetId}/generate_flow`, {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({})
  });
  const j = await r.json();
  if(!j.ok){
    document.getElementById('pseudo_status').innerText = 'âŒ '+(j.error||'ç”Ÿæˆæµç¨‹å¤±è´¥');
    return;
  }
  document.getElementById('pseudo_status').innerText = `âœ… å·²ç”Ÿæˆæµç¨‹ã€Œ${j.name}ã€ï¼Œå‘½ä»¤ ${j.command}`;
  loadFlows();
  setActivePanel('flows');
}

async function sandboxPseudo(id){
  if(!currentBotId){ alert('å…ˆé€‰æ‹©ä¸€ä¸ª bot'); return; }
  const targetId = id || document.getElementById('pseudo_id').value;
  if(!targetId){
    document.getElementById('pseudo_status').innerText = 'âŒ è¯·å…ˆé€‰æ‹©æˆ–ä¿å­˜ä¼ªä»£ç ã€‚';
    return;
  }
  const sandboxInputEl = document.getElementById('sandbox_input');
  const sandboxInputVal = sandboxInputEl ? sandboxInputEl.value : '';
  const r = await fetch(`/api/bots/${currentBotId}/pseudocode/${targetId}/sandbox`, {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ input: sandboxInputVal || '/demo' })
  });
  const j = await r.json();
  const box = document.getElementById('sandbox_output');
  if(!j.ok){
    box.classList.remove('hidden');
    box.textContent = 'âŒ '+(j.error||'æ²™ç›’è¿è¡Œå¤±è´¥');
    return;
  }
  const lines = [];
  lines.push(`å‘½ä»¤: ${j.command}`);
  lines.push(j.summary || '');
  (j.actions||[]).forEach((act, idx)=>{
    lines.push(`${idx+1}. [${act.type}] ${act.text || act.url || act.prompt || JSON.stringify(act)}`);
  });
  if(j.analysis){
    lines.push('\nè§£æ:');
    lines.push(j.analysis);
  }
  box.classList.remove('hidden');
  box.textContent = lines.join('\n');
  setActivePanel('pseudo');
}

async function aiGeneratePseudo(){
  const prompt = document.getElementById('pseudo_ai_prompt').value.trim();
  const r = await fetch('/api/ai/generate', {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ mode:'pseudocode', prompt })
  });
  const j = await r.json();
  if(!j.ok){
    document.getElementById('pseudo_status').innerText = 'âŒ '+(j.error||'AI ç”Ÿæˆå¤±è´¥');
    return;
  }
  const result = j.result || {};
  document.getElementById('pseudo_title').value = result.title || '';
  document.getElementById('pseudo_content').value = result.content || '';
  const meta = j.meta || {};
  let note = 'ğŸ¤– å·²æ ¹æ®æç¤ºç”Ÿæˆä¼ªä»£ç ï¼Œè®°å¾—ä¿å­˜ã€‚';
  if(meta.api_key_configured === false){
    note += 'ï¼ˆå½“å‰ä½¿ç”¨å†…ç½®æ¨¡æ¿ï¼Œå¦‚éœ€æ¥å…¥çœŸå® AIï¼Œè¯·åœ¨ç¯å¢ƒå˜é‡ AI_API_KEY ä¸­é…ç½®å¯†é’¥ã€‚ï¼‰';
  }
  document.getElementById('pseudo_status').innerText = note;
  setActivePanel('pseudo');
}

/* ---------- ç›‘æ§ & æ—¥å¿— ---------- */
function fmtUptime(sec){
  return fmt.time(sec);
}
function badge(state){
  const map = { running:'bg-emerald-100 text-emerald-700', stopped:'bg-gray-100 text-gray-700', errored:'bg-red-100 text-red-700', starting:'bg-amber-100 text-amber-700' };
  const cls = map[state] || 'bg-gray-100 text-gray-700';
  return `<span class="px-2 py-0.5 rounded ${cls}">${state}</span>`;
}
async function refreshStatus(){
  if(!currentBotId) return;
  try {
    if(statusCache[currentBotId]){
      updateStatusTable(statusCache[currentBotId]);
    }
    const res = await fetch(`/api/bots/${currentBotId}/status`, { credentials:'same-origin' });
    const data = await res.json();
    const status = data.status || {};
    const prior = statusCache[currentBotId] || {};
    statusCache[currentBotId] = Object.assign({}, prior, status, { bot_id: currentBotId, name: prior.name || status.name });
    updateStatusTable(statusCache[currentBotId]);
  } catch (err) {
    console.warn('refresh status failed', err);
  }

  try {
    const logRes = await fetch(`/api/bots/${currentBotId}/logs?lines=150`, { credentials:'same-origin' });
    const logs = (await logRes.json()).items || [];
    const box = document.getElementById('log_box');
    box.textContent = logs.map(entry => {
      const ts = new Date((entry.ts||0)*1000).toLocaleTimeString();
      return `[${ts}] ${entry.level||'info'}: ${entry.msg}`;
    }).join('\n');
    box.scrollTop = box.scrollHeight;
  } catch (err) {
    console.warn('refresh logs failed', err);
  }

  updateRuntimeSummary();
}




panelTabs.forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    setActivePanel(btn.dataset.panel);
  });
});
setActivePanel(activePanel);

const kindSel = document.getElementById('kind');
const mediaUrl = document.getElementById('media_url');
if(kindSel && mediaUrl){
  const syncMediaField = () => {
    mediaUrl.classList.toggle('hidden', kindSel.value === 'text');
  };
  kindSel.addEventListener('change', syncMediaField);
  syncMediaField();
}

me();
</script>
</body>
</html>
